<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>The OPAQUE Asymmetric PAKE Protocol</title>
<meta content="Daniel Bourdrez" name="author">
<meta content="Hugo Krawczyk" name="author">
<meta content="Kevin Lewi" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       This document describes the OPAQUE protocol, a secure asymmetric
password-authenticated key exchange (aPAKE) that supports mutual
authentication in a client-server setting without reliance on PKI and
with security against pre-computation attacks upon server compromise.
In addition, the protocol provides forward secrecy and the ability to
hide the password from the server, even during password registration.
This document specifies the core OPAQUE protocol and one instantiation
based on 3DH. 
    " name="description">
<meta content="xml2rfc 3.12.10" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-irtf-cfrg-opaque-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.12.10
    Python 3.10.4
    appdirs 1.4.4
    ConfigArgParse 1.5.3
    google-i18n-address 2.5.1
    html5lib 1.1
    intervaltree 3.1.0
    Jinja2 2.11.3
    kitchen 1.2.6
    lxml 4.8.0
    MarkupSafe 2.0.1
    pycountry 20.7.3
    pyflakes 2.4.0
    PyYAML 6.0
    requests 2.27.1
    setuptools 59.4.0
    six 1.16.0
-->
<link href="draft-irtf-cfrg-opaque.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
dd.break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href].selfRef {
  color: var(--text-color);
}
a[href] {
  color: var(--link-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: 14.5px;
}
.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 8em;
}
#identifiers dt {
  width: var(--identifier-width);
  margin: 0;
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0 0 0 calc(1em + var(--identifier-width));
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([stroke="fill"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">OPAQUE</td>
<td class="right">June 2022</td>
</tr></thead>
<tfoot><tr>
<td class="left">Bourdrez, et al.</td>
<td class="center">Expires 1 January 2023</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-irtf-cfrg-opaque-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2022-06-30" class="published">30 June 2022</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2023-01-01">1 January 2023</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">D. Bourdrez</div>
</div>
<div class="author">
      <div class="author-name">H. Krawczyk</div>
<div class="org">Algorand Foundation</div>
</div>
<div class="author">
      <div class="author-name">K. Lewi</div>
<div class="org">Novi Research</div>
</div>
<div class="author">
      <div class="author-name">C. A. Wood</div>
<div class="org">Cloudflare, Inc.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">The OPAQUE Asymmetric PAKE Protocol</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes the OPAQUE protocol, a secure asymmetric
password-authenticated key exchange (aPAKE) that supports mutual
authentication in a client-server setting without reliance on PKI and
with security against pre-computation attacks upon server compromise.
In addition, the protocol provides forward secrecy and the ability to
hide the password from the server, even during password registration.
This document specifies the core OPAQUE protocol and one instantiation
based on 3DH.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues">
<a href="#name-discussion-venues" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Source for this draft and an issue tracker can be found at
  <span><a href="https://github.com/cfrg/draft-irtf-cfrg-opaque">https://github.com/cfrg/draft-irtf-cfrg-opaque</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 1 January 2023.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2022 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="xref">1.1</a>.  <a href="#name-requirements-notation" class="xref">Requirements Notation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2">
                <p id="section-toc.1-1.1.2.2.1" class="keepWithNext"><a href="#section-1.2" class="xref">1.2</a>.  <a href="#name-notation" class="xref">Notation</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="xref">2</a>.  <a href="#name-cryptographic-dependencies" class="xref">Cryptographic Dependencies</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1" class="xref">2.1</a>.  <a href="#name-oblivious-pseudorandom-func" class="xref">Oblivious Pseudorandom Function</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="xref">2.2</a>.  <a href="#name-key-derivation-function-and" class="xref">Key Derivation Function and Message Authentication Code</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="xref">2.3</a>.  <a href="#name-hash-functions" class="xref">Hash Functions</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-protocol-overview" class="xref">Protocol Overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-setup" class="xref">Setup</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-offline-registration" class="xref">Offline Registration</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="xref">3.3</a>.  <a href="#name-online-authenticated-key-ex" class="xref">Online Authenticated Key Exchange</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-client-credential-storage-a" class="xref">Client Credential Storage and Key Recovery</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-key-recovery" class="xref">Key Recovery</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1" class="xref">4.1.1</a>.  <a href="#name-envelope-structure" class="xref">Envelope Structure</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2" class="xref">4.1.2</a>.  <a href="#name-envelope-creation" class="xref">Envelope Creation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.3">
                    <p id="section-toc.1-1.4.2.1.2.3.1"><a href="#section-4.1.3" class="xref">4.1.3</a>.  <a href="#name-envelope-recovery" class="xref">Envelope Recovery</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-offline-registration-2" class="xref">Offline Registration</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-registration-messages" class="xref">Registration Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-registration-functions" class="xref">Registration Functions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.1">
                    <p id="section-toc.1-1.5.2.2.2.1.1"><a href="#section-5.2.1" class="xref">5.2.1</a>.  <a href="#name-createregistrationrequest" class="xref">CreateRegistrationRequest</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.2">
                    <p id="section-toc.1-1.5.2.2.2.2.1"><a href="#section-5.2.2" class="xref">5.2.2</a>.  <a href="#name-createregistrationresponse" class="xref">CreateRegistrationResponse</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.3">
                    <p id="section-toc.1-1.5.2.2.2.3.1"><a href="#section-5.2.3" class="xref">5.2.3</a>.  <a href="#name-finalizeregistrationrequest" class="xref">FinalizeRegistrationRequest</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-online-authenticated-key-exc" class="xref">Online Authenticated Key Exchange</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-ake-messages" class="xref">AKE Messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="xref">6.2</a>.  <a href="#name-ake-functions" class="xref">AKE Functions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.1">
                    <p id="section-toc.1-1.6.2.2.2.1.1"><a href="#section-6.2.1" class="xref">6.2.1</a>.  <a href="#name-clientinit" class="xref">ClientInit</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.2">
                    <p id="section-toc.1-1.6.2.2.2.2.1"><a href="#section-6.2.2" class="xref">6.2.2</a>.  <a href="#name-serverinit" class="xref">ServerInit</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.3">
                    <p id="section-toc.1-1.6.2.2.2.3.1"><a href="#section-6.2.3" class="xref">6.2.3</a>.  <a href="#name-clientfinish" class="xref">ClientFinish</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2.2.4">
                    <p id="section-toc.1-1.6.2.2.2.4.1"><a href="#section-6.2.4" class="xref">6.2.4</a>.  <a href="#name-serverfinish" class="xref">ServerFinish</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="xref">6.3</a>.  <a href="#name-credential-retrieval" class="xref">Credential Retrieval</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.1">
                    <p id="section-toc.1-1.6.2.3.2.1.1"><a href="#section-6.3.1" class="xref">6.3.1</a>.  <a href="#name-credential-retrieval-messag" class="xref">Credential Retrieval Messages</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3.2.2">
                    <p id="section-toc.1-1.6.2.3.2.2.1"><a href="#section-6.3.2" class="xref">6.3.2</a>.  <a href="#name-credential-retrieval-functi" class="xref">Credential Retrieval Functions</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4">
                <p id="section-toc.1-1.6.2.4.1"><a href="#section-6.4" class="xref">6.4</a>.  <a href="#name-ake-protocol" class="xref">AKE Protocol</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.1">
                    <p id="section-toc.1-1.6.2.4.2.1.1"><a href="#section-6.4.1" class="xref">6.4.1</a>.  <a href="#name-key-creation" class="xref">Key Creation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.2">
                    <p id="section-toc.1-1.6.2.4.2.2.1"><a href="#section-6.4.2" class="xref">6.4.2</a>.  <a href="#name-key-schedule-functions" class="xref">Key Schedule Functions</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.3">
                    <p id="section-toc.1-1.6.2.4.2.3.1"><a href="#section-6.4.3" class="xref">6.4.3</a>.  <a href="#name-3dh-client-functions" class="xref">3DH Client Functions</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.4">
                    <p id="section-toc.1-1.6.2.4.2.4.1"><a href="#section-6.4.4" class="xref">6.4.4</a>.  <a href="#name-3dh-server-functions" class="xref">3DH Server Functions</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-configurations" class="xref">Configurations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-application-considerations" class="xref">Application Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-implementation-consideratio" class="xref">Implementation Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="xref">9.1</a>.  <a href="#name-implementation-safeguards" class="xref">Implementation Safeguards</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="xref">9.2</a>.  <a href="#name-error-considerations" class="xref">Error Considerations</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-security-considerations" class="xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-notable-design-differences" class="xref">Notable Design Differences</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-security-analysis" class="xref">Security Analysis</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="xref">10.3</a>.  <a href="#name-related-protocols" class="xref">Related Protocols</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.4">
                <p id="section-toc.1-1.10.2.4.1"><a href="#section-10.4" class="xref">10.4</a>.  <a href="#name-identities" class="xref">Identities</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.5">
                <p id="section-toc.1-1.10.2.5.1"><a href="#section-10.5" class="xref">10.5</a>.  <a href="#name-export-key-usage" class="xref">Export Key Usage</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.6">
                <p id="section-toc.1-1.10.2.6.1"><a href="#section-10.6" class="xref">10.6</a>.  <a href="#name-static-diffie-hellman-oracl" class="xref">Static Diffie-Hellman Oracles</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.7">
                <p id="section-toc.1-1.10.2.7.1"><a href="#section-10.7" class="xref">10.7</a>.  <a href="#name-input-validation" class="xref">Input Validation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.8">
                <p id="section-toc.1-1.10.2.8.1"><a href="#section-10.8" class="xref">10.8</a>.  <a href="#name-oprf-key-stretching" class="xref">OPRF Key Stretching</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.9">
                <p id="section-toc.1-1.10.2.9.1"><a href="#section-10.9" class="xref">10.9</a>.  <a href="#name-client-enumeration" class="xref">Client Enumeration</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.10">
                <p id="section-toc.1-1.10.2.10.1"><a href="#section-10.10" class="xref">10.10</a>. <a href="#name-password-salt-and-storage-i" class="xref">Password Salt and Storage Implications</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.11">
                <p id="section-toc.1-1.10.2.11.1"><a href="#section-10.11" class="xref">10.11</a>. <a href="#name-ake-private-key-storage" class="xref">AKE Private Key Storage</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="xref">11</a>. <a href="#name-iana-considerations" class="xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="xref">12</a>. <a href="#name-references" class="xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1" class="xref">12.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2" class="xref">12.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#appendix-A" class="xref">Appendix A</a>.  <a href="#name-acknowledgments" class="xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#appendix-B" class="xref">Appendix B</a>.  <a href="#name-alternate-key-recovery-mech" class="xref">Alternate Key Recovery Mechanisms</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#appendix-C" class="xref">Appendix C</a>.  <a href="#name-alternate-ake-instantiation" class="xref">Alternate AKE Instantiations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.1">
                <p id="section-toc.1-1.15.2.1.1"><a href="#appendix-C.1" class="xref">C.1</a>.  <a href="#name-hmqv-instantiation-sketch" class="xref">HMQV Instantiation Sketch</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15.2.2">
                <p id="section-toc.1-1.15.2.2.1"><a href="#appendix-C.2" class="xref">C.2</a>.  <a href="#name-sigma-i-instantiation-sketc" class="xref">SIGMA-I Instantiation Sketch</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#appendix-D" class="xref">Appendix D</a>.  <a href="#name-test-vectors" class="xref">Test Vectors</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1">
                <p id="section-toc.1-1.16.2.1.1"><a href="#appendix-D.1" class="xref">D.1</a>.  <a href="#name-real-test-vectors" class="xref">Real Test Vectors</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1.2.1">
                    <p id="section-toc.1-1.16.2.1.2.1.1"><a href="#appendix-D.1.1" class="xref">D.1.1</a>.  <a href="#name-opaque-3dh-real-test-vector" class="xref">OPAQUE-3DH Real Test Vector 1</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1.2.2">
                    <p id="section-toc.1-1.16.2.1.2.2.1"><a href="#appendix-D.1.2" class="xref">D.1.2</a>.  <a href="#name-opaque-3dh-real-test-vector-" class="xref">OPAQUE-3DH Real Test Vector 2</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1.2.3">
                    <p id="section-toc.1-1.16.2.1.2.3.1"><a href="#appendix-D.1.3" class="xref">D.1.3</a>.  <a href="#name-opaque-3dh-real-test-vector-3" class="xref">OPAQUE-3DH Real Test Vector 3</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.1.2.4">
                    <p id="section-toc.1-1.16.2.1.2.4.1"><a href="#appendix-D.1.4" class="xref">D.1.4</a>.  <a href="#name-opaque-3dh-real-test-vector-4" class="xref">OPAQUE-3DH Real Test Vector 4</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.2">
                <p id="section-toc.1-1.16.2.2.1"><a href="#appendix-D.2" class="xref">D.2</a>.  <a href="#name-fake-test-vectors" class="xref">Fake Test Vectors</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.2.2.1">
                    <p id="section-toc.1-1.16.2.2.2.1.1"><a href="#appendix-D.2.1" class="xref">D.2.1</a>.  <a href="#name-opaque-3dh-fake-test-vector" class="xref">OPAQUE-3DH Fake Test Vector 1</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16.2.2.2.2">
                    <p id="section-toc.1-1.16.2.2.2.2.1"><a href="#appendix-D.2.2" class="xref">D.2.2</a>.  <a href="#name-opaque-3dh-fake-test-vector-" class="xref">OPAQUE-3DH Fake Test Vector 2</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#appendix-E" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="intro">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Password authentication is ubiquitous in many applications. In a common
implementation, a client authenticates to a server by sending its client
ID and password to the server over a secure connection. This makes
the password vulnerable to server mishandling, including accidentally
logging the password or storing it in plaintext in a database. Server
compromise resulting in access to these plaintext passwords is not an
uncommon security incident, even among security-conscious organizations.
Moreover, plaintext password authentication over secure channels such as
TLS is also vulnerable to cases where TLS may fail, including PKI
attacks, certificate mishandling, termination outside the security
perimeter, visibility to TLS-terminating intermediaries, and more.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Asymmetric (or Augmented) Password Authenticated Key Exchange (aPAKE)
protocols are designed to provide password authentication and
mutually authenticated key exchange in a client-server setting without
relying on PKI (except during client registration) and without
disclosing passwords to servers or other entities other than the client
machine. A secure aPAKE should provide the best possible security for a
password protocol. Indeed, some attacks are inevitable, such as
online impersonation attempts with guessed client passwords and offline
dictionary attacks upon the compromise of a server and leakage of its
credential file. In the latter case, the attacker learns a mapping of
a client's password under a one-way function and uses such a mapping to
validate potential guesses for the password. Crucially important is
for the password protocol to use an unpredictable one-way mapping.
Otherwise, the attacker can pre-compute a deterministic list of mapped
passwords leading to almost instantaneous leakage of passwords upon
server compromise.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">This document describes OPAQUE, a PKI-free secure aPAKE that is secure
against pre-computation attacks. OPAQUE provides forward secrecy with
respect to password leakage while also hiding the password from the
server, even during password registration. OPAQUE allows applications
to increase the difficulty of offline dictionary attacks via iterated
hashing or other key stretching schemes. OPAQUE is also extensible, allowing
clients to safely store and retrieve arbitrary application data on servers
using only their password.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">OPAQUE is defined and proven as the composition of three functionalities:
an oblivious pseudorandom function (OPRF), a key recovery mechanism,
and an authenticated key exchange (AKE) protocol. It can be seen
as a "compiler" for transforming any suitable AKE protocol into a secure
aPAKE protocol. (See <a href="#security-considerations" class="xref">Section 10</a> for requirements of the
OPRF and AKE protocols.) This document specifies one OPAQUE instantiation
based on <span>[<a href="#_3DH" class="xref">_3DH</a>]</span>. Other instantiations are possible, as discussed in
<a href="#alternate-akes" class="xref">Appendix C</a>, but their details are out of scope for this document.
In general, the modularity of OPAQUE's design makes it easy to integrate
with additional AKE protocols, e.g., TLS or HMQV, and with future ones such
as those based on post-quantum techniques.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">OPAQUE consists of two stages: registration and authenticated key exchange.
In the first stage, a client registers its password with the server and stores
information used to recover authentication credentials on the server. Recovering these
credentials can only be done with knowledge of the client password. In the second
stage, a client uses its password to recover those credentials and subsequently
uses them as input to an AKE protocol. This stage has additional mechanisms to
prevent an active attacker from interacting with the server to guess or confirm
clients registered via the first phase. Servers can use this mechanism to safeguard
registered clients against this type of enumeration attack; see
<a href="#preventing-client-enumeration" class="xref">Section 10.9</a> for more discussion.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">The name OPAQUE is a homonym of O-PAKE where O is for Oblivious. The name
OPAKE was taken.<a href="#section-1-6" class="pilcrow">¶</a></p>
<p id="section-1-7">This draft complies with the requirements for PAKE protocols set forth in
<span>[<a href="#RFC8125" class="xref">RFC8125</a>]</span>.<a href="#section-1-7" class="pilcrow">¶</a></p>
<div id="requirements-notation">
<section id="section-1.1">
        <h3 id="name-requirements-notation">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-requirements-notation" class="section-name selfRef">Requirements Notation</a>
        </h3>
<p id="section-1.1-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED",
"MAY", and "OPTIONAL" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="notation">
<section id="section-1.2">
        <h3 id="name-notation">
<a href="#section-1.2" class="section-number selfRef">1.2. </a><a href="#name-notation" class="section-name selfRef">Notation</a>
        </h3>
<p id="section-1.2-1">The following functions are used throughout this document:<a href="#section-1.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.2-2.1">I2OSP and OS2IP: Convert a byte string to and from a non-negative integer as
described in Section 4 of <span>[<a href="#RFC8017" class="xref">RFC8017</a>]</span>. Note that these functions operate on
byte strings in big-endian byte order.<a href="#section-1.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.2-2.2">concat(x0, ..., xN): Concatenate byte strings. For example,
<code>concat(0x01, 0x0203, 0x040506) = 0x010203040506</code>.<a href="#section-1.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.2-2.3">random(n): Generate a cryptographically secure pseudorandom byte string of length <code>n</code> bytes.<a href="#section-1.2-2.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.2-2.4">xor(a,b): Apply XOR to byte strings. For example, <code>xor(0xF0F0, 0x1234) = 0xE2C4</code>.
It is an error to call this function with arguments of unequal length.<a href="#section-1.2-2.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-1.2-2.5">ct_equal(a, b): Return <code>true</code> if <code>a</code> is equal to <code>b</code>, and false otherwise.
The implementation of this function must be constant-time in the length of <code>a</code>
and <code>b</code>, which are assumed to be of equal length, irrespective of the values <code>a</code>
or <code>b</code>.<a href="#section-1.2-2.5" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-1.2-3">Except if said otherwise, random choices in this specification refer to
drawing with uniform distribution from a given set (i.e., "random" is short
for "uniformly random"). Random choices can be replaced with fresh outputs from
a cryptographically strong pseudorandom generator, according to the requirements
in <span>[<a href="#RFC4086" class="xref">RFC4086</a>]</span>, or pseudorandom function. For convenience, we define <code>nil</code> as a
lack of value.<a href="#section-1.2-3" class="pilcrow">¶</a></p>
<p id="section-1.2-4">All protocol messages and structures defined in this document use the syntax from
<span>[<a href="#RFC8446" class="xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a></span>.<a href="#section-1.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="dependencies">
<section id="section-2">
      <h2 id="name-cryptographic-dependencies">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-cryptographic-dependencies" class="section-name selfRef">Cryptographic Dependencies</a>
      </h2>
<p id="section-2-1">OPAQUE depends on the following cryptographic protocols and primitives:<a href="#section-2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-2.1">Oblivious Pseudorandom Function (OPRF); <a href="#deps-oprf" class="xref">Section 2.1</a><a href="#section-2-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.2">Key Derivation Function (KDF); <a href="#deps-symmetric" class="xref">Section 2.2</a><a href="#section-2-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.3">Message Authentication Code (MAC); <a href="#deps-symmetric" class="xref">Section 2.2</a><a href="#section-2-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.4">Cryptographic Hash Function; <a href="#deps-hash" class="xref">Section 2.3</a><a href="#section-2-2.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-2-2.5">Key Stretching Function (KSF); <a href="#deps-hash" class="xref">Section 2.3</a><a href="#section-2-2.5" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-2-3">This section describes these protocols and primitives in more detail. Unless said
otherwise, all random nonces and seeds used in these dependencies and the rest of
the OPAQUE protocol are of length <code>Nn</code> and <code>Nseed</code> bytes, respectively, where
<code>Nn</code> = <code>Nseed</code> = 32.<a href="#section-2-3" class="pilcrow">¶</a></p>
<div id="deps-oprf">
<section id="section-2.1">
        <h3 id="name-oblivious-pseudorandom-func">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-oblivious-pseudorandom-func" class="section-name selfRef">Oblivious Pseudorandom Function</a>
        </h3>
<p id="section-2.1-1">An Oblivious Pseudorandom Function (OPRF) is a two-party protocol between client and
server for computing a PRF such that the client learns the PRF output and neither party learns
the input of the other. This specification depends on the prime-order OPRF construction specified
in <span>[<a href="#OPRF" class="xref">OPRF</a>]</span>, draft version -10, using the OPRF mode (0x00) from <span>[<a href="#OPRF" class="xref">OPRF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-3.1" class="relref">Section 3.1</a></span>.<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<p id="section-2.1-2">The following OPRF client APIs are used:<a href="#section-2.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.1-3.1">Blind(element): Create and output (<code>blind</code>, <code>blinded_element</code>), consisting of a blinded
representation of input <code>element</code>, denoted <code>blinded_element</code>, along with a value to revert
the blinding process, denoted <code>blind</code>.<a href="#section-2.1-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.1-3.2">Finalize(element, blind, evaluated_element): Finalize the OPRF evaluation using input <code>element</code>,
random inverter <code>blind</code>, and evaluation output <code>evaluated_element</code>, yielding output <code>oprf_output</code>.<a href="#section-2.1-3.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-2.1-4">Moreover, the following OPRF server APIs are used:<a href="#section-2.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.1-5.1">Evaluate(k, blinded_element): Evaluate blinded input element <code>blinded_element</code> using
input key <code>k</code>, yielding output element <code>evaluated_element</code>. This is equivalent to
the Evaluate function described in <span>[<a href="#OPRF" class="xref">OPRF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-3.3.1" class="relref">Section 3.3.1</a></span>, where <code>k</code> is the private key parameter.<a href="#section-2.1-5.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.1-5.2">DeriveKeyPair(seed, info): Derive a private and public key pair deterministically
from a seed and info parameter, as described in <span>[<a href="#OPRF" class="xref">OPRF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-3.2" class="relref">Section 3.2</a></span>.<a href="#section-2.1-5.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-2.1-6">Finally, this specification makes use of the following shared APIs and parameters:<a href="#section-2.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.1-7.1">SerializeElement(element): Map input <code>element</code> to a fixed-length byte array <code>buf</code>.<a href="#section-2.1-7.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.1-7.2">DeserializeElement(buf): Attempt to map input byte array <code>buf</code> to an OPRF group element.
This function can raise a DeserializeError upon failure; see <span>[<a href="#OPRF" class="xref">OPRF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-2.1" class="relref">Section 2.1</a></span>
for more details.<a href="#section-2.1-7.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.1-7.3">Noe: The size of a serialized OPRF group element output from SerializeElement.<a href="#section-2.1-7.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.1-7.4">Nok: The size of an OPRF private key as output from DeriveKeyPair.<a href="#section-2.1-7.4" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="deps-symmetric">
<section id="section-2.2">
        <h3 id="name-key-derivation-function-and">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-key-derivation-function-and" class="section-name selfRef">Key Derivation Function and Message Authentication Code</a>
        </h3>
<p id="section-2.2-1">A Key Derivation Function (KDF) is a function that takes some source of initial
keying material and uses it to derive one or more cryptographically strong keys.
This specification uses a KDF with the following API and parameters:<a href="#section-2.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.2-2.1">Extract(salt, ikm): Extract a pseudorandom key of fixed length <code>Nx</code> bytes from
input keying material <code>ikm</code> and an optional byte string <code>salt</code>.<a href="#section-2.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.2-2.2">Expand(prk, info, L): Expand a pseudorandom key <code>prk</code> using optional string <code>info</code>
into <code>L</code> bytes of output keying material.<a href="#section-2.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.2-2.3">Nx: The output size of the <code>Extract()</code> function in bytes.<a href="#section-2.2-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-2.2-3">This specification also makes use of a collision-resistant Message Authentication Code
(MAC) with the following API and parameters:<a href="#section-2.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.2-4.1">MAC(key, msg): Compute a message authentication code over input <code>msg</code> with key
<code>key</code>, producing a fixed-length output of <code>Nm</code> bytes.<a href="#section-2.2-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.2-4.2">Nm: The output size of the <code>MAC()</code> function in bytes.<a href="#section-2.2-4.2" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="deps-hash">
<section id="section-2.3">
        <h3 id="name-hash-functions">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-hash-functions" class="section-name selfRef">Hash Functions</a>
        </h3>
<p id="section-2.3-1">This specification makes use of a collision-resistant hash function with the following
API and parameters:<a href="#section-2.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.3-2.1">Hash(msg): Apply a cryptographic hash function to input <code>msg</code>, producing a
fixed-length digest of size <code>Nh</code> bytes.<a href="#section-2.3-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-2.3-2.2">Nh: The output size of the <code>Hash()</code> function in bytes.<a href="#section-2.3-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-2.3-3">This specification makes use of a Key Stretching Function (KSF), which is a slow
and expensive cryptographic hash function with the following API:<a href="#section-2.3-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.3-4.1">Stretch(msg, params): Apply a key stretching function with parameters
<code>params</code> to stretch the input <code>msg</code> and harden it against offline
dictionary attacks. This function also needs to satisfy collision resistance.<a href="#section-2.3-4.1" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="protocol-overview">
<section id="section-3">
      <h2 id="name-protocol-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-protocol-overview" class="section-name selfRef">Protocol Overview</a>
      </h2>
<p id="section-3-1">OPAQUE consists of two stages: registration and authenticated key exchange.
In the first stage, a client registers its password with the server and stores
its credential file on the server. In the second stage (also called the
"login" stage), the client recovers its authentication material and uses it to
perform a mutually authenticated key exchange.<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="setup">
<section id="section-3.1">
        <h3 id="name-setup">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-setup" class="section-name selfRef">Setup</a>
        </h3>
<p id="section-3.1-1">Prior to both stages, the client and server agree on a configuration that
fully specifies the cryptographic algorithm dependencies necessary to run the
protocol; see <a href="#configurations" class="xref">Section 7</a> for details.
The server chooses a pair of keys (<code>server_private_key</code> and <code>server_public_key</code>)
for the AKE, and chooses a seed (<code>oprf_seed</code>) of <code>Nh</code> bytes for the OPRF.
The server can use this single pair of keys with multiple
clients and can opt to use multiple seeds (so long as they are kept consistent for
each client).<a href="#section-3.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="offline-registration">
<section id="section-3.2">
        <h3 id="name-offline-registration">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-offline-registration" class="section-name selfRef">Offline Registration</a>
        </h3>
<p id="section-3.2-1">Registration is the only stage in OPAQUE that requires a server-authenticated
and confidential channel: either physical, out-of-band, PKI-based, etc.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The client inputs its credentials, which includes its password and user
identifier, and the server inputs its parameters, which includes its private key
and other information.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">The client output of this stage is a single value <code>export_key</code> that the client
may use for application-specific purposes, e.g., to encrypt additional
information for storage on the server. The server does not have access to this
<code>export_key</code>.<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<p id="section-3.2-4">The server output of this stage is a record corresponding to the client's
registration that it stores in a credential file alongside other client
registrations as needed.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
<p id="section-3.2-5">The registration flow is shown below:<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.2-6">
<pre>
    creds                                   parameters
      |                                         |
      v                                         v
    Client                                    Server
    ------------------------------------------------
                registration request
             -------------------------&gt;
                registration response
             &lt;-------------------------
                      record
             -------------------------&gt;
   ------------------------------------------------
      |                                         |
      v                                         v
  export_key                                 record
</pre><a href="#section-3.2-6" class="pilcrow">¶</a>
</div>
<p id="section-3.2-7">These messages are named <code>RegistrationRequest</code>, <code>RegistrationResponse</code>, and
<code>RegistrationRecord</code>, respectively. Their contents and wire format are defined in
<a href="#registration-messages" class="xref">Section 5.1</a>.<a href="#section-3.2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="online-authenticated-key-exchange">
<section id="section-3.3">
        <h3 id="name-online-authenticated-key-ex">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-online-authenticated-key-ex" class="section-name selfRef">Online Authenticated Key Exchange</a>
        </h3>
<p id="section-3.3-1">In this second stage, a client obtains credentials previously registered
with the server, recovers private key material using the password, and
subsequently uses them as input to the AKE protocol. As in the registration
phase, the client inputs its credentials, including its password and user
identifier, and the server inputs its parameters and the credential file record
corresponding to the client. The client outputs two values, an <code>export_key</code>
(matching that from registration) and a <code>session_key</code>, the latter of which
is the primary AKE output. The server outputs a single value <code>session_key</code>
that matches that of the client. Upon completion, clients and servers can
use these values as needed.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.3-2">The authenticated key exchange flow is shown below:<a href="#section-3.3-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.3-3">
<pre>
    creds                             (parameters, record)
      |                                         |
      v                                         v
    Client                                    Server
    ------------------------------------------------
                   AKE message 1
             -------------------------&gt;
                   AKE message 2
             &lt;-------------------------
                   AKE message 3
             -------------------------&gt;
   ------------------------------------------------
      |                                         |
      v                                         v
(export_key, session_key)                  session_key
</pre><a href="#section-3.3-3" class="pilcrow">¶</a>
</div>
<p id="section-3.3-4">These messages are named <code>KE1</code>, <code>KE2</code>, and <code>KE3</code>, respectively. They carry the
messages of the concurrent execution of the key recovery process (OPRF) and the
authenticated key exchange (AKE), and their corresponding wire formats are
specified in <a href="#ake-messages" class="xref">Section 6.1</a>.<a href="#section-3.3-4" class="pilcrow">¶</a></p>
<p id="section-3.3-5">The rest of this document describes the details of these stages in detail.
<a href="#client-material" class="xref">Section 4</a> describes how client credential information is
generated, encoded, and stored on the server during registration, and recovered during
login. <a href="#offline-phase" class="xref">Section 5</a> describes the first registration stage of the protocol,
and <a href="#online-phase" class="xref">Section 6</a> describes the second authentication stage of the protocol.
<a href="#configurations" class="xref">Section 7</a> describes how to instantiate OPAQUE using different
cryptographic dependencies and parameters.<a href="#section-3.3-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-material">
<section id="section-4">
      <h2 id="name-client-credential-storage-a">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-client-credential-storage-a" class="section-name selfRef">Client Credential Storage and Key Recovery</a>
      </h2>
<p id="section-4-1">OPAQUE makes use of a structure called <code>Envelope</code> to manage client credentials.
The client creates its <code>Envelope</code> on registration and sends it to the server for
storage. On every login, the server sends this <code>Envelope</code> to the client so it can
recover its key material for use in the AKE.<a href="#section-4-1" class="pilcrow">¶</a></p>
<p id="section-4-2">Future variants of OPAQUE may use different key recovery mechanisms. See <a href="#key-recovery" class="xref">Section 4.1</a> for details.<a href="#section-4-2" class="pilcrow">¶</a></p>
<p id="section-4-3">Applications may pin key material to identities if desired. If no identity is given
for a party, its value MUST default to its public key. The following types of
application credential information are considered:<a href="#section-4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4-4.1">client_private_key: The encoded client private key for the AKE protocol.<a href="#section-4-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.2">client_public_key: The encoded client public key for the AKE protocol.<a href="#section-4-4.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.3">server_public_key: The encoded server public key for the AKE protocol.<a href="#section-4-4.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.4">client_identity: The client identity. This is an application-specific value,
e.g., an e-mail address or an account name. If not specified, it defaults
to the client's public key.<a href="#section-4-4.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-4-4.5">server_identity: The server identity. This is typically a domain name, e.g., example.com.
If not specified, it defaults to the server's public key. See <a href="#identities" class="xref">Section 10.4</a> for
information about this identity.<a href="#section-4-4.5" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-4-5">These credential values are used in the <code>CleartextCredentials</code> structure as follows:<a href="#section-4-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4-6">
<pre>
struct {
  uint8 server_public_key[Npk];
  uint8 server_identity&lt;1..2^16-1&gt;;
  uint8 client_identity&lt;1..2^16-1&gt;;
} CleartextCredentials;
</pre><a href="#section-4-6" class="pilcrow">¶</a>
</div>
<p id="section-4-7">The function CreateCleartextCredentials constructs a <code>CleartextCredentials</code> structure given
application credential information.<a href="#section-4-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4-8">
<pre>
CreateCleartextCredentials

Input:
- server_public_key, the encoded server public key for the AKE protocol.
- client_public_key, the encoded client public key for the AKE protocol.
- server_identity, the optional encoded server identity.
- client_identity, the optional encoded client identity.

Output:
- cleartext_credentials, a CleartextCredentials structure.

def CreateCleartextCredentials(server_public_key, client_public_key,
                               server_identity, client_identity):
  # Set identities as public keys if no application-layer identity is provided
  if server_identity == nil
    server_identity = server_public_key
  if client_identity == nil
    client_identity = client_public_key

  Create CleartextCredentials cleartext_credentials with
    (server_public_key, server_identity, client_identity)
  return cleartext_credentials
</pre><a href="#section-4-8" class="pilcrow">¶</a>
</div>
<div id="key-recovery">
<section id="section-4.1">
        <h3 id="name-key-recovery">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-key-recovery" class="section-name selfRef">Key Recovery</a>
        </h3>
<p id="section-4.1-1">This specification defines a key recovery mechanism that uses the stretched OPRF
output as a seed to directly derive the private and public key using the
<code>DeriveAuthKeyPair()</code> function defined in <a href="#key-creation" class="xref">Section 6.4.1</a>.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<div id="envelope-structure">
<section id="section-4.1.1">
          <h4 id="name-envelope-structure">
<a href="#section-4.1.1" class="section-number selfRef">4.1.1. </a><a href="#name-envelope-structure" class="section-name selfRef">Envelope Structure</a>
          </h4>
<p id="section-4.1.1-1">The key recovery mechanism defines its <code>Envelope</code> as follows:<a href="#section-4.1.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1.1-2">
<pre>
struct {
  uint8 nonce[Nn];
  uint8 auth_tag[Nm];
} Envelope;
</pre><a href="#section-4.1.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1-3">nonce: A unique nonce of length <code>Nn</code> used to protect this <code>Envelope</code>.<a href="#section-4.1.1-3" class="pilcrow">¶</a></p>
<p id="section-4.1.1-4">auth_tag: An authentication tag protecting the contents of the envelope, covering
the envelope nonce and <code>CleartextCredentials</code>.<a href="#section-4.1.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="envelope-creation">
<section id="section-4.1.2">
          <h4 id="name-envelope-creation">
<a href="#section-4.1.2" class="section-number selfRef">4.1.2. </a><a href="#name-envelope-creation" class="section-name selfRef">Envelope Creation</a>
          </h4>
<p id="section-4.1.2-1">Clients create an <code>Envelope</code> at registration with the function <code>Store</code> defined
below.<a href="#section-4.1.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1.2-2">
<pre>
Store

Input:
- randomized_pwd, a randomized password.
- server_public_key, the encoded server public key for
  the AKE protocol.
- server_identity, the optional encoded server identity.
- client_identity, the optional encoded client identity.

Output:
- envelope, the client's Envelope structure.
- client_public_key, the client's AKE public key.
- masking_key, an encryption key used by the server with the sole purpose
  of defending against client enumeration attacks.
- export_key, an additional client key.

def Store(randomized_pwd, server_public_key, server_identity, client_identity):
  envelope_nonce = random(Nn)
  masking_key = Expand(randomized_pwd, "MaskingKey", Nh)
  auth_key = Expand(randomized_pwd, concat(envelope_nonce, "AuthKey"), Nh)
  export_key = Expand(randomized_pwd, concat(envelope_nonce, "ExportKey"), Nh)
  seed = Expand(randomized_pwd, concat(envelope_nonce, "PrivateKey"), Nseed)
  (_, client_public_key) = DeriveAuthKeyPair(seed)

  cleartext_creds =
    CreateCleartextCredentials(server_public_key, client_public_key,
                               server_identity, client_identity)
  auth_tag = MAC(auth_key, concat(envelope_nonce, cleartext_creds))

  Create Envelope envelope with (envelope_nonce, auth_tag)
  return (envelope, client_public_key, masking_key, export_key)
</pre><a href="#section-4.1.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="envelope-recovery">
<section id="section-4.1.3">
          <h4 id="name-envelope-recovery">
<a href="#section-4.1.3" class="section-number selfRef">4.1.3. </a><a href="#name-envelope-recovery" class="section-name selfRef">Envelope Recovery</a>
          </h4>
<p id="section-4.1.3-1">Clients recover their <code>Envelope</code> during login with the <code>Recover</code> function
defined below.<a href="#section-4.1.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1.3-2">
<pre>
Recover

Input:
- randomized_pwd, a randomized password.
- server_public_key, the encoded server public key for the AKE protocol.
- envelope, the client's Envelope structure.
- server_identity, the optional encoded server identity.
- client_identity, the optional encoded client identity.

Output:
- client_private_key, the encoded client private key for the AKE protocol.
- export_key, an additional client key.

Exceptions:
- EnvelopeRecoveryError, the envelope fails to be recovered.

def Recover(randomized_pwd, server_public_key, envelope,
            server_identity, client_identity):
  auth_key = Expand(randomized_pwd, concat(envelope.nonce, "AuthKey"), Nh)
  export_key = Expand(randomized_pwd, concat(envelope.nonce, "ExportKey", Nh)
  seed = Expand(randomized_pwd, concat(envelope.nonce, "PrivateKey"), Nseed)
  (client_private_key, client_public_key) = DeriveAuthKeyPair(seed)

  cleartext_creds = CreateCleartextCredentials(server_public_key,
                      client_public_key, server_identity, client_identity)
  expected_tag = MAC(auth_key, concat(envelope.nonce, cleartext_creds))
  If !ct_equal(envelope.auth_tag, expected_tag)
    raise EnvelopeRecoveryError
  return (client_private_key, export_key)
</pre><a href="#section-4.1.3-2" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="offline-phase">
<section id="section-5">
      <h2 id="name-offline-registration-2">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-offline-registration-2" class="section-name selfRef">Offline Registration</a>
      </h2>
<p id="section-5-1">The registration process proceeds as follows. The client inputs
the following values:<a href="#section-5-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-2.1">password: The client's password.<a href="#section-5-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-2.2">creds: The client credentials, as described in <a href="#client-material" class="xref">Section 4</a>.<a href="#section-5-2.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-5-3">The server inputs the following values:<a href="#section-5-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-4.1">server_private_key: The server private key for the AKE protocol.<a href="#section-5-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-4.2">server_public_key: The server public key for the AKE protocol.<a href="#section-5-4.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-4.3">credential_identifier: A unique identifier for the client's
credential, generated by the server.<a href="#section-5-4.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-4.4">client_identity: The optional client identity as described in <a href="#client-material" class="xref">Section 4</a>.<a href="#section-5-4.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-4.5">oprf_seed: A seed used to derive per-client OPRF keys.<a href="#section-5-4.5" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-5-5">The registration protocol then runs as shown below:<a href="#section-5-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5-6">
<pre>
  Client                                         Server
 ------------------------------------------------------
 (request, blind) = CreateRegistrationRequest(password)

                        request
              -------------------------&gt;

 response = CreateRegistrationResponse(request,
                                       server_public_key,
                                       credential_identifier,
                                       oprf_seed)

                        response
              &lt;-------------------------

 (record, export_key) = FinalizeRegistrationRequest(response,
                                                    server_identity,
                                                    client_identity)

                        record
              -------------------------&gt;
</pre><a href="#section-5-6" class="pilcrow">¶</a>
</div>
<p id="section-5-7"><a href="#registration-messages" class="xref">Section 5.1</a> describes the formats for the above messages, and
<a href="#registration-functions" class="xref">Section 5.2</a> describes details of the functions and the
corresponding parameters referenced above.<a href="#section-5-7" class="pilcrow">¶</a></p>
<p id="section-5-8">At the end of this interaction, the server stores the <code>record</code> object as the
credential file for each client along with the associated <code>credential_identifier</code>
and <code>client_identity</code> (if different). Note that the values <code>oprf_seed</code> and
<code>server_private_key</code> from the server's setup phase must also be persisted.
The <code>oprf_seed</code> value SHOULD be used for all clients; see <a href="#preventing-client-enumeration" class="xref">Section 10.9</a>.
The <code>server_private_key</code> may be unique for each client.<a href="#section-5-8" class="pilcrow">¶</a></p>
<p id="section-5-9">Both client and server MUST validate the other party's public key before use.
See <a href="#validation" class="xref">Section 10.7</a> for more details. Upon completion, the server stores
the client's credentials for later use. Moreover, the client MAY use the output
<code>export_key</code> for further application-specific purposes; see <a href="#export-key-usage" class="xref">Section 10.5</a>.<a href="#section-5-9" class="pilcrow">¶</a></p>
<div id="registration-messages">
<section id="section-5.1">
        <h3 id="name-registration-messages">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-registration-messages" class="section-name selfRef">Registration Messages</a>
        </h3>
<p id="section-5.1-1">This section contains definitions of the <code>RegistrationRequest</code>,
<code>RegistrationResponse</code>, and <code>RegistrationRecord</code> messages exchanged between
client and server during registration.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-2">
<pre>
struct {
  uint8 blinded_message[Noe];
} RegistrationRequest;
</pre><a href="#section-5.1-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1-3">blinded_message: A serialized OPRF group element.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-4">
<pre>
struct {
  uint8 evaluated_message[Noe];
  uint8 server_public_key[Npk];
} RegistrationResponse;
</pre><a href="#section-5.1-4" class="pilcrow">¶</a>
</div>
<p id="section-5.1-5">evaluated_message: A serialized OPRF group element.<a href="#section-5.1-5" class="pilcrow">¶</a></p>
<p id="section-5.1-6">server_public_key: The server's encoded public key that will be used for
the online AKE stage.<a href="#section-5.1-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-7">
<pre>
struct {
  uint8 client_public_key[Npk];
  uint8 masking_key[Nh];
  Envelope envelope;
} RegistrationRecord;
</pre><a href="#section-5.1-7" class="pilcrow">¶</a>
</div>
<p id="section-5.1-8">client_public_key: The client's encoded public key, corresponding to
the private key <code>client_private_key</code>.<a href="#section-5.1-8" class="pilcrow">¶</a></p>
<p id="section-5.1-9">masking_key: An encryption key used by the server to preserve
confidentiality of the envelope during login to defend against
client enumeration attacks.<a href="#section-5.1-9" class="pilcrow">¶</a></p>
<p id="section-5.1-10">envelope: The client's <code>Envelope</code> structure.<a href="#section-5.1-10" class="pilcrow">¶</a></p>
</section>
</div>
<div id="registration-functions">
<section id="section-5.2">
        <h3 id="name-registration-functions">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-registration-functions" class="section-name selfRef">Registration Functions</a>
        </h3>
<p id="section-5.2-1">This section contains definitions of the functions used by client and server
during registration, including <code>CreateRegistrationRequest</code>, <code>CreateRegistrationResponse</code>,
and <code>FinalizeRegistrationRequest</code>.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<div id="createregistrationrequest">
<section id="section-5.2.1">
          <h4 id="name-createregistrationrequest">
<a href="#section-5.2.1" class="section-number selfRef">5.2.1. </a><a href="#name-createregistrationrequest" class="section-name selfRef">CreateRegistrationRequest</a>
          </h4>
<p id="section-5.2.1-1">To begin the registration flow, the client executes the following function.<a href="#section-5.2.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2.1-2">
<pre>
CreateRegistrationRequest

Input:
- password, an opaque byte string containing the client's password.

Output:
- request, a RegistrationRequest structure.
- blind, an OPRF scalar value.

def CreateRegistrationRequest(password):
  (blind, blinded_element) = Blind(password)
  blinded_message = SerializeElement(blinded_element)
  Create RegistrationRequest request with blinded_message
  return (request, blind)
</pre><a href="#section-5.2.1-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="create-reg-response">
<section id="section-5.2.2">
          <h4 id="name-createregistrationresponse">
<a href="#section-5.2.2" class="section-number selfRef">5.2.2. </a><a href="#name-createregistrationresponse" class="section-name selfRef">CreateRegistrationResponse</a>
          </h4>
<p id="section-5.2.2-1">To process the client's registration request, the server executes
the following function.<a href="#section-5.2.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2.2-2">
<pre>
CreateRegistrationResponse

Input:
- request, a RegistrationRequest structure.
- server_public_key, the server's public key.
- credential_identifier, an identifier that uniquely represents the credential.
- oprf_seed, the seed of Nh bytes used by the server to generate an oprf_key.

Output:
- response, a RegistrationResponse structure.

Exceptions:
- DeserializeError, when OPRF element deserialization fails.

def CreateRegistrationResponse(request, server_public_key,
                               credential_identifier, oprf_seed):
  seed = Expand(oprf_seed, concat(credential_identifier, "OprfKey"), Nok)
  (oprf_key, _) = DeriveKeyPair(seed, "OPAQUE-DeriveKeyPair")

  blinded_element = DeserializeElement(request.blinded_message)
  evaluated_element = Evaluate(oprf_key, blinded_element)
  evaluated_message = SerializeElement(evaluated_element)

  Create RegistrationResponse response with (evaluated_message, server_public_key)
  return response
</pre><a href="#section-5.2.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="finalize-request">
<section id="section-5.2.3">
          <h4 id="name-finalizeregistrationrequest">
<a href="#section-5.2.3" class="section-number selfRef">5.2.3. </a><a href="#name-finalizeregistrationrequest" class="section-name selfRef">FinalizeRegistrationRequest</a>
          </h4>
<p id="section-5.2.3-1">To create the user record used for subsequent authentication and complete the
registration flow, the client executes the following function.<a href="#section-5.2.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2.3-2">
<pre>
FinalizeRegistrationRequest

Input:
- password, an opaque byte string containing the client's password.
- blind, an OPRF scalar value.
- response, a RegistrationResponse structure.
- server_identity, the optional encoded server identity.
- client_identity, the optional encoded client identity.

Output:
- record, a RegistrationRecord structure.
- export_key, an additional client key.

Exceptions:
- DeserializeError, when OPRF element deserialization fails.

def FinalizeRegistrationRequest(password, blind, response, server_identity, client_identity):
  evaluated_element = DeserializeElement(response.evaluated_message)
  oprf_output = Finalize(password, blind, evaluated_element)

  stretched_oprf_output = Stretch(oprf_output, params)
  randomized_pwd = Extract("", concat(oprf_output, stretched_oprf_output))

  (envelope, client_public_key, masking_key, export_key) =
    Store(randomized_pwd, response.server_public_key,
          server_identity, client_identity)
  Create RegistrationRecord record with (client_public_key, masking_key, envelope)
  return (record, export_key)
</pre><a href="#section-5.2.3-2" class="pilcrow">¶</a>
</div>
<p id="section-5.2.3-3">See <a href="#online-phase" class="xref">Section 6</a> for details about the output <code>export_key</code> usage.<a href="#section-5.2.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="online-phase">
<section id="section-6">
      <h2 id="name-online-authenticated-key-exc">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-online-authenticated-key-exc" class="section-name selfRef">Online Authenticated Key Exchange</a>
      </h2>
<p id="section-6-1">The generic outline of OPAQUE with a 3-message AKE protocol includes three messages:
<code>KE1</code>, <code>KE2</code>, and <code>KE3</code>, where <code>KE1</code> and <code>KE2</code> include key exchange shares, e.g., DH values, sent
by the client and server, respectively, and <code>KE3</code> provides explicit client authentication and
full forward security (without it, forward secrecy is only achieved against eavesdroppers,
which is insufficient for OPAQUE security).<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">This section describes the online authenticated key exchange protocol flow,
message encoding, and helper functions. This stage is composed of a concurrent
OPRF and key exchange flow. The key exchange protocol is authenticated using the
client and server credentials established during registration; see <a href="#offline-phase" class="xref">Section 5</a>.
In the end, the client proves its knowledge of the password, and both client and
server agree on (1) a mutually authenticated shared secret key and (2) any optional
application information exchange during the handshake.<a href="#section-6-2" class="pilcrow">¶</a></p>
<p id="section-6-3">In this stage, the client inputs the following values:<a href="#section-6-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6-4.1">password: The client's password.<a href="#section-6-4.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-4.2">client_identity: The client identity, as described in <a href="#client-material" class="xref">Section 4</a>.<a href="#section-6-4.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-6-5">The server inputs the following values:<a href="#section-6-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6-6.1">server_private_key: The server's private key for the AKE protocol.<a href="#section-6-6.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-6.2">server_public_key: The server's public key for the AKE protocol.<a href="#section-6-6.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-6.3">server_identity: The server identity, as described in <a href="#client-material" class="xref">Section 4</a>.<a href="#section-6-6.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-6.4">record: The <code>RegistrationRecord</code> object corresponding to the client's registration.<a href="#section-6-6.4" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-6.5">credential_identifier: An identifier that uniquely represents the credential.<a href="#section-6-6.5" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-6.6">oprf_seed: The seed used to derive per-client OPRF keys.<a href="#section-6-6.6" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-6-7">The client receives two outputs: a session secret and an export key. The export
key is only available to the client, and may be used for additional
application-specific purposes, as outlined in <a href="#export-key-usage" class="xref">Section 10.5</a>. The output
<code>export_key</code> MUST NOT be used in any way before the protocol completes
successfully. See <a href="#alternate-key-recovery" class="xref">Appendix B</a> for more details about this
requirement. The server receives a single output: a session secret matching the
client's.<a href="#section-6-7" class="pilcrow">¶</a></p>
<p id="section-6-8">The protocol runs as shown below:<a href="#section-6-8" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6-9">
<pre>
  Client                                         Server
 ------------------------------------------------------
  ke1 = ClientInit(password)

                         ke1
              -------------------------&gt;

  ke2 = ServerInit(server_identity, server_private_key,
                    server_public_key, record,
                    credential_identifier, oprf_seed, ke1)

                         ke2
              &lt;-------------------------

    (ke3,
    session_key,
    export_key) = ClientFinish(client_identity,
                               server_identity, ke2)

                         ke3
              -------------------------&gt;

                       session_key = ServerFinish(ke3)
</pre><a href="#section-6-9" class="pilcrow">¶</a>
</div>
<p id="section-6-10">Both client and server may use implicit internal state objects to keep necessary
material for the OPRF and AKE, <code>client_state</code> and <code>server_state</code>, respectively.<a href="#section-6-10" class="pilcrow">¶</a></p>
<p id="section-6-11">The client state <code>ClientState</code> may have the following fields:<a href="#section-6-11" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6-12.1">password: The client's password.<a href="#section-6-12.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-12.2">blind: The random blinding inverter returned by <code>Blind()</code>.<a href="#section-6-12.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-6-12.3">client_ake_state: The <code>ClientAkeState</code> defined in <a href="#ake-protocol" class="xref">Section 6.4</a>.<a href="#section-6-12.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-6-13">The server state <code>ServerState</code> may have the following fields:<a href="#section-6-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6-14.1">server_ake_state: The <code>ServerAkeState</code> defined in <a href="#ake-protocol" class="xref">Section 6.4</a>.<a href="#section-6-14.1" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-6-15">The rest of this section describes these authenticated key exchange messages
and their parameters in more detail. <a href="#ake-messages" class="xref">Section 6.1</a> defines the structure of the
messages passed between client and server in the above setup. <a href="#ake-functions" class="xref">Section 6.2</a>
describes details of the functions and corresponding parameters mentioned above.
<a href="#cred-retrieval" class="xref">Section 6.3</a> discusses internal functions used for retrieving client
credentials, and <a href="#ake-protocol" class="xref">Section 6.4</a> discusses how these functions are used to execute
the authenticated key exchange protocol.<a href="#section-6-15" class="pilcrow">¶</a></p>
<div id="ake-messages">
<section id="section-6.1">
        <h3 id="name-ake-messages">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-ake-messages" class="section-name selfRef">AKE Messages</a>
        </h3>
<p id="section-6.1-1">In this section, we define the <code>KE1</code>, <code>KE2</code>, and <code>KE3</code> structs which make up
the AKE messages used in the protocol. <code>KE1</code> is composed of a <code>CredentialRequest</code>
and <code>AuthRequest</code>, and <code>KE2</code> is composed of a <code>CredentialResponse</code>
and <code>AuthResponse</code>.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-2">
<pre>
struct {
  uint8 client_nonce[Nn];
  uint8 client_keyshare[Npk];
} AuthRequest;
</pre><a href="#section-6.1-2" class="pilcrow">¶</a>
</div>
<p id="section-6.1-3">client_nonce: A fresh randomly generated nonce of length <code>Nn</code>.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1-4">client_keyshare: A serialized client ephemeral key share of fixed size <code>Npk</code>.<a href="#section-6.1-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-5">
<pre>
struct {
  CredentialRequest credential_request;
  AuthRequest auth_request;
} KE1;
</pre><a href="#section-6.1-5" class="pilcrow">¶</a>
</div>
<p id="section-6.1-6">credential_request: A <code>CredentialRequest</code> structure.<a href="#section-6.1-6" class="pilcrow">¶</a></p>
<p id="section-6.1-7">auth_request: An <code>AuthRequest</code> structure.<a href="#section-6.1-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-8">
<pre>
struct {
  uint8 server_nonce[Nn];
  uint8 server_keyshare[Npk];
  uint8 server_mac[Nm];
} AuthResponse;
</pre><a href="#section-6.1-8" class="pilcrow">¶</a>
</div>
<p id="section-6.1-9">server_nonce: A fresh randomly generated nonce of length <code>Nn</code>.<a href="#section-6.1-9" class="pilcrow">¶</a></p>
<p id="section-6.1-10">server_keyshare: Server ephemeral key share of fixed size <code>Npk</code>, where <code>Npk</code>
depends on the corresponding prime order group.<a href="#section-6.1-10" class="pilcrow">¶</a></p>
<p id="section-6.1-11">server_mac: An authentication tag computed over the handshake transcript
computed using <code>Km2</code>, defined below.<a href="#section-6.1-11" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-12">
<pre>
struct {
  CredentialResponse credential_response;
  AuthResponse auth_response;
} KE2;
</pre><a href="#section-6.1-12" class="pilcrow">¶</a>
</div>
<p id="section-6.1-13">credential_response: A <code>CredentialResponse</code> structure.<a href="#section-6.1-13" class="pilcrow">¶</a></p>
<p id="section-6.1-14">auth_response: An <code>AuthResponse</code> structure.<a href="#section-6.1-14" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.1-15">
<pre>
struct {
  uint8 client_mac[Nm];
} KE3;
</pre><a href="#section-6.1-15" class="pilcrow">¶</a>
</div>
<p id="section-6.1-16">client_mac: An authentication tag computed over the handshake transcript
of fixed size <code>Nm</code>, computed using <code>Km2</code>, defined below.<a href="#section-6.1-16" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ake-functions">
<section id="section-6.2">
        <h3 id="name-ake-functions">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-ake-functions" class="section-name selfRef">AKE Functions</a>
        </h3>
<p id="section-6.2-1">In this section, we define the main functions used to produce the AKE messages
in the protocol. Note that this section relies on definitions of subroutines defined
in later sections:
- <code>CreateCredentialRequest</code>, <code>CreateCredentialResponse</code>, <code>RecoverCredentials</code>
  defined in <a href="#cred-retrieval" class="xref">Section 6.3</a>
- <code>AuthClientStart</code>, <code>AuthServerRespond</code>, <code>AuthClientFinalize</code>, and <code>AuthServerFinalize</code>
  defined in <a href="#ake-client" class="xref">Section 6.4.3</a> and <a href="#ake-server" class="xref">Section 6.4.4</a><a href="#section-6.2-1" class="pilcrow">¶</a></p>
<div id="clientinit">
<section id="section-6.2.1">
          <h4 id="name-clientinit">
<a href="#section-6.2.1" class="section-number selfRef">6.2.1. </a><a href="#name-clientinit" class="section-name selfRef">ClientInit</a>
          </h4>
<p id="section-6.2.1-1">The <code>ClientInit</code> function begins the AKE protocol and produces the client's <code>KE1</code>
output for the server.<a href="#section-6.2.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.2.1-2">
<pre>
ClientInit

State:
- state, a ClientState structure.

Input:
- password, an opaque byte string containing the client's password.

Output:
- ke1, a KE1 message structure.

def ClientInit(password):
  credential_request, blind = CreateCredentialRequest(password)
  state.password = password
  state.blind = blind
  ke1 = AuthClientStart(request)
  return ke1
</pre><a href="#section-6.2.1-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="serverinit">
<section id="section-6.2.2">
          <h4 id="name-serverinit">
<a href="#section-6.2.2" class="section-number selfRef">6.2.2. </a><a href="#name-serverinit" class="section-name selfRef">ServerInit</a>
          </h4>
<p id="section-6.2.2-1">The <code>ServerInit</code> function continues the AKE protocol by processing the client's <code>KE1</code> message
and producing the server's <code>KE2</code> output.<a href="#section-6.2.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.2.2-2">
<pre>
ServerInit

State:
- state, a ServerState structure.

Input:
- server_identity, the optional encoded server identity, which is set to
  server_public_key if nil.
- server_private_key, the server's private key.
- server_public_key, the server's public key.
- record, the client's RegistrationRecord structure.
- credential_identifier, an identifier that uniquely represents the credential.
- oprf_seed, the server-side seed of Nh bytes used to generate an oprf_key.
- ke1, a KE1 message structure.
- client_identity, the encoded client identity.

Output:
- ke2, a KE2 structure.

def ServerInit(server_identity, server_private_key, server_public_key,
               record, credential_identifier, oprf_seed, ke1, client_identity):
  credential_response = CreateCredentialResponse(ke1.request, server_public_key, record,
    credential_identifier, oprf_seed)
  auth_response = AuthServerRespond(server_identity, server_private_key,
    client_identity, record.client_public_key, ke1, credential_response)
  Create KE2 ke2 with (credential_response, auth_response)
</pre><a href="#section-6.2.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="clientfinish">
<section id="section-6.2.3">
          <h4 id="name-clientfinish">
<a href="#section-6.2.3" class="section-number selfRef">6.2.3. </a><a href="#name-clientfinish" class="section-name selfRef">ClientFinish</a>
          </h4>
<p id="section-6.2.3-1">The <code>ClientFinish</code> function completes the AKE protocol for the client and
produces the client's <code>KE3</code> output for the server, as well as the <code>session_key</code>
and <code>export_key</code> outputs from the AKE.<a href="#section-6.2.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.2.3-2">
<pre>
ClientFinish

State:
- state, a ClientState structure.

Input:
- client_identity, the optional encoded client identity, which is set
  to client_public_key if not specified.
- server_identity, the optional encoded server identity, which is set
  to server_public_key if not specified.
- ke2, a KE2 message structure.

Output:
- ke3, a KE3 message structure.
- session_key, the session's shared secret.
- export_key, an additional client key.

def ClientFinish(client_identity, server_identity, ke2):
  (client_private_key, server_public_key, export_key) =
    RecoverCredentials(state.password, state.blind, ke2.credential_response,
                       server_identity, client_identity)
  (ke3, session_key) =
    AuthClientFinalize(client_identity, client_private_key, server_identity,
                       server_public_key, ke2)
  return (ke3, session_key, export_key)
</pre><a href="#section-6.2.3-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="serverfinish">
<section id="section-6.2.4">
          <h4 id="name-serverfinish">
<a href="#section-6.2.4" class="section-number selfRef">6.2.4. </a><a href="#name-serverfinish" class="section-name selfRef">ServerFinish</a>
          </h4>
<p id="section-6.2.4-1">The <code>ServerFinish</code> function completes the AKE protocol for the server, yielding the <code>session_key</code>.
Since the OPRF is a two-message protocol, <code>KE3</code> has no element of the OPRF, and it
therefore invokes the AKE's <code>AuthServerFinalize</code> directly. The <code>AuthServerFinalize</code> function
takes <code>KE3</code> as input and MUST verify the client authentication material it contains
before the <code>session_key</code> value can be used. This verification is necessary to ensure
forward secrecy against active attackers.<a href="#section-6.2.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.2.4-2">
<pre>
ServerFinish

State:
- state, a ServerState structure.

Input:
- ke3, a KE3 structure.

Output:
- session_key, the shared session secret if and only if ke3 is valid.

def ServerFinish(ke3):
  return AuthServerFinalize(ke3)
</pre><a href="#section-6.2.4-2" class="pilcrow">¶</a>
</div>
<p id="section-6.2.4-3">This function MUST NOT return the <code>session_key</code> value if the client authentication
material is invalid, and may instead return an appropriate error message such as
ClientAuthenticationError, invoked from <code>AuthServerFinalize</code>.<a href="#section-6.2.4-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="cred-retrieval">
<section id="section-6.3">
        <h3 id="name-credential-retrieval">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-credential-retrieval" class="section-name selfRef">Credential Retrieval</a>
        </h3>
<p id="section-6.3-1">This section describes the sub-protocol run during authentication to retrieve and
recover the client credentials.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<div id="credential-retrieval-messages">
<section id="section-6.3.1">
          <h4 id="name-credential-retrieval-messag">
<a href="#section-6.3.1" class="section-number selfRef">6.3.1. </a><a href="#name-credential-retrieval-messag" class="section-name selfRef">Credential Retrieval Messages</a>
          </h4>
<p id="section-6.3.1-1">This section describes the <code>CredentialRequest</code> and <code>CredentialResponse</code> messages exchanged
between client and server to perform credential retrieval.<a href="#section-6.3.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.1-2">
<pre>
struct {
  uint8 blinded_message[Noe];
} CredentialRequest;
</pre><a href="#section-6.3.1-2" class="pilcrow">¶</a>
</div>
<p id="section-6.3.1-3">blinded_message: A serialized OPRF group element.<a href="#section-6.3.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.1-4">
<pre>
struct {
  uint8 evaluated_message[Noe];
  uint8 masking_nonce[Nn];
  uint8 masked_response[Npk + Ne];
} CredentialResponse;
</pre><a href="#section-6.3.1-4" class="pilcrow">¶</a>
</div>
<p id="section-6.3.1-5">evaluated_message: A serialized OPRF group element.<a href="#section-6.3.1-5" class="pilcrow">¶</a></p>
<p id="section-6.3.1-6">masking_nonce: A nonce used for the confidentiality of the
<code>masked_response</code> field.<a href="#section-6.3.1-6" class="pilcrow">¶</a></p>
<p id="section-6.3.1-7">masked_response: An encrypted form of the server's public key and the
client's <code>Envelope</code> structure.<a href="#section-6.3.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="credential-retrieval-functions">
<section id="section-6.3.2">
          <h4 id="name-credential-retrieval-functi">
<a href="#section-6.3.2" class="section-number selfRef">6.3.2. </a><a href="#name-credential-retrieval-functi" class="section-name selfRef">Credential Retrieval Functions</a>
          </h4>
<p id="section-6.3.2-1">This section describes the <code>CreateCredentialRequest</code>, <code>CreateCredentialResponse</code>,
and <code>RecoverCredentials</code> functions used for credential retrieval.<a href="#section-6.3.2-1" class="pilcrow">¶</a></p>
<div id="create-credential-request">
<section id="section-6.3.2.1">
            <h5 id="name-createcredentialrequest">
<a href="#section-6.3.2.1" class="section-number selfRef">6.3.2.1. </a><a href="#name-createcredentialrequest" class="section-name selfRef">CreateCredentialRequest</a>
            </h5>
<p id="section-6.3.2.1-1">The <code>CreateCredentialRequest</code> is used by the client to initiate the credential
retrieval process, and it produces a <code>CredentialRequest</code> message and OPRF state.<a href="#section-6.3.2.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.2.1-2">
<pre>
CreateCredentialRequest

Input:
- password, an opaque byte string containing the client's password.

Output:
- request, a CredentialRequest structure.
- blind, an OPRF scalar value.

def CreateCredentialRequest(password):
  (blind, blinded_element) = Blind(password)
  blinded_message = SerializeElement(blinded_element)
  Create CredentialRequest request with blinded_message
  return (request, blind)
</pre><a href="#section-6.3.2.1-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="create-credential-response">
<section id="section-6.3.2.2">
            <h5 id="name-createcredentialresponse">
<a href="#section-6.3.2.2" class="section-number selfRef">6.3.2.2. </a><a href="#name-createcredentialresponse" class="section-name selfRef">CreateCredentialResponse</a>
            </h5>
<p id="section-6.3.2.2-1">The <code>CreateCredentialResponse</code> function is used by the server to process the client's
<code>CredentialRequest</code> message and complete the credential retrieval process, producing
a <code>CredentialResponse</code>.<a href="#section-6.3.2.2-1" class="pilcrow">¶</a></p>
<p id="section-6.3.2.2-2">There are two scenarios to handle for the construction of a <code>CredentialResponse</code>
object: either the record for the client exists (corresponding to a properly
registered client), or it was never created (corresponding to a client that has
yet to register).<a href="#section-6.3.2.2-2" class="pilcrow">¶</a></p>
<p id="section-6.3.2.2-3">In the case of an existing record with the corresponding identifier
<code>credential_identifier</code>, the server invokes the following function to
produce a <code>CredentialResponse</code>:<a href="#section-6.3.2.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.2.2-4">
<pre>
CreateCredentialResponse

Input:
- request, a CredentialRequest structure.
- server_public_key, the public key of the server.
- record, an instance of RegistrationRecord which is the server's
  output from registration.
- credential_identifier, an identifier that uniquely represents the credential.
- oprf_seed, the server-side seed of Nh bytes used to generate an oprf_key.

Output:
- response, a CredentialResponse structure.

Exceptions:
- DeserializeError, when OPRF element deserialization fails.

def CreateCredentialResponse(request, server_public_key, record,
                             credential_identifier, oprf_seed):
  seed = Expand(oprf_seed, concat(credential_identifier, "OprfKey"), Nok)
  (oprf_key, _) = DeriveKeyPair(seed, "OPAQUE-DeriveKeyPair")

  blinded_element = DeserializeElement(request.blinded_message)
  evaluated_element = Evaluate(oprf_key, blinded_element)
  evaluated_message = SerializeElement(evaluated_element)

  masking_nonce = random(Nn)
  credential_response_pad = Expand(record.masking_key,
                                   concat(masking_nonce, "CredentialResponsePad"),
                                   Npk + Ne)
  masked_response = xor(credential_response_pad,
                        concat(server_public_key, record.envelope))
  Create CredentialResponse response with (evaluated_message, masking_nonce, masked_response)
  return response
</pre><a href="#section-6.3.2.2-4" class="pilcrow">¶</a>
</div>
<p id="section-6.3.2.2-5">In the case of a record that does not exist and if client enumeration prevention is desired,
the server MUST respond to the credential request to fake the existence of the record.
The server SHOULD invoke the <code>CreateCredentialResponse</code> function with a fake client record
argument that is configured so that:<a href="#section-6.3.2.2-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.3.2.2-6.1">
                <code>record.client_public_key</code> is set to a randomly generated public key of length <code>Npk</code><a href="#section-6.3.2.2-6.1" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.3.2.2-6.2">
                <code>record.masking_key</code> is set to a random byte string of length <code>Nh</code><a href="#section-6.3.2.2-6.2" class="pilcrow">¶</a>
</li>
              <li class="normal" id="section-6.3.2.2-6.3">
                <code>record.envelope</code> is set to the byte string consisting only of zeros of length <code>Ne</code><a href="#section-6.3.2.2-6.3" class="pilcrow">¶</a>
</li>
            </ul>
<p id="section-6.3.2.2-7">It is RECOMMENDED that a fake client record is created once (e.g. as the first user record
of the application) and stored alongside legitimate client records. This allows servers to locate
the record in time comparable to that of a legitimate client record.<a href="#section-6.3.2.2-7" class="pilcrow">¶</a></p>
<p id="section-6.3.2.2-8">Note that the responses output by either scenario are indistinguishable to an adversary
that is unable to guess the registered password for the client corresponding to <code>credential_identifier</code>.<a href="#section-6.3.2.2-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="recover-credentials">
<section id="section-6.3.2.3">
            <h5 id="name-recovercredentials">
<a href="#section-6.3.2.3" class="section-number selfRef">6.3.2.3. </a><a href="#name-recovercredentials" class="section-name selfRef">RecoverCredentials</a>
            </h5>
<p id="section-6.3.2.3-1">The <code>RecoverCredentials</code> function is used by the client to process the server's
<code>CredentialResponse</code> message and produce the client's private key, server public
key, and the <code>export_key</code>.<a href="#section-6.3.2.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.3.2.3-2">
<pre>
RecoverCredentials

Input:
- password, an opaque byte string containing the client's password.
- blind, an OPRF scalar value.
- response, a CredentialResponse structure.
- server_identity, The optional encoded server identity.
- client_identity, The encoded client identity.

Output:
- client_private_key, the client's private key for the AKE protocol.
- server_public_key, the public key of the server.
- export_key, an additional client key.

Exceptions:
- DeserializeError, when OPRF element deserialization fails.

def RecoverCredentials(password, blind, response,
                       server_identity, client_identity):
  evaluated_element = DeserializeElement(response.evaluated_message)

  oprf_output = Finalize(password, blind, evaluated_element)
  stretched_oprf_output = Stretch(oprf_output, params)
  randomized_pwd = Extract("", concat(oprf_output, stretched_oprf_output))

  masking_key = Expand(randomized_pwd, "MaskingKey", Nh)
  credential_response_pad = Expand(masking_key,
                                   concat(response.masking_nonce, "CredentialResponsePad"),
                                   Npk + Ne)
  concat(server_public_key, envelope) = xor(credential_response_pad,
                                              response.masked_response)
  (client_private_key, export_key) =
    Recover(randomized_pwd, server_public_key, envelope,
            server_identity, client_identity)

  return (client_private_key, server_public_key, export_key)
</pre><a href="#section-6.3.2.3-2" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="ake-protocol">
<section id="section-6.4">
        <h3 id="name-ake-protocol">
<a href="#section-6.4" class="section-number selfRef">6.4. </a><a href="#name-ake-protocol" class="section-name selfRef">AKE Protocol</a>
        </h3>
<p id="section-6.4-1">This section describes the authenticated key exchange protocol for OPAQUE using
3DH, a 3-message AKE which satisfies the forward secrecy and KCI properties
discussed in <a href="#security-considerations" class="xref">Section 10</a>.<a href="#section-6.4-1" class="pilcrow">¶</a></p>
<p id="section-6.4-2">The client AKE state <code>ClientAkeState</code> mentioned in <a href="#online-phase" class="xref">Section 6</a> has the
following fields:<a href="#section-6.4-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.4-3.1">client_secret: An opaque byte string of length <code>Nsk</code>.<a href="#section-6.4-3.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-6.4-3.2">ke1: A value of type <code>KE1</code>.<a href="#section-6.4-3.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-6.4-4">The server AKE state <code>ServerAkeState</code> mentioned in <a href="#online-phase" class="xref">Section 6</a> has the
following fields:
- expected_client_mac: An opaque byte string of length <code>Nm</code>.
- session_key: An opaque byte string of length <code>Nx</code>.<a href="#section-6.4-4" class="pilcrow">¶</a></p>
<p id="section-6.4-5"><a href="#ake-client" class="xref">Section 6.4.3</a> and <a href="#ake-server" class="xref">Section 6.4.4</a> specify the inner workings of client and
server functions, respectively.<a href="#section-6.4-5" class="pilcrow">¶</a></p>
<div id="key-creation">
<section id="section-6.4.1">
          <h4 id="name-key-creation">
<a href="#section-6.4.1" class="section-number selfRef">6.4.1. </a><a href="#name-key-creation" class="section-name selfRef">Key Creation</a>
          </h4>
<p id="section-6.4.1-1">We assume the following functions to exist for all candidate groups in this
setting:<a href="#section-6.4.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.4.1-2.1">DeriveAuthKeyPair(seed): Derive a private and public authentication key pair
deterministically from the input <code>seed</code>. This function is implemented as
DeriveKeyPair(seed, "OPAQUE-DeriveAuthKeyPair"), where DeriveKeyPair is
as specified in <span>[<a href="#OPRF" class="xref">OPRF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-3.2" class="relref">Section 3.2</a></span>.<a href="#section-6.4.1-2.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.4.1-2.2">GenerateAuthKeyPair(): Return a randomly generated private and public key
pair. This can be implemented by invoking DeriveAuthKeyPair with <code>Nseed</code>
random bytes as input.<a href="#section-6.4.1-2.2" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.4.1-2.3">SerializeElement(element): A member function of the underlying group that
maps <code>element</code> to a unique byte array, mirrored from the definition of the
similarly-named function of the OPRF group described in
<span>[<a href="#OPRF" class="xref">OPRF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-2.1" class="relref">Section 2.1</a></span>.<a href="#section-6.4.1-2.3" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="key-schedule-functions">
<section id="section-6.4.2">
          <h4 id="name-key-schedule-functions">
<a href="#section-6.4.2" class="section-number selfRef">6.4.2. </a><a href="#name-key-schedule-functions" class="section-name selfRef">Key Schedule Functions</a>
          </h4>
<p id="section-6.4.2-1">This section contains functions used for the AKE key schedule.<a href="#section-6.4.2-1" class="pilcrow">¶</a></p>
<div id="transcript-functions">
<section id="section-6.4.2.1">
            <h5 id="name-transcript-functions">
<a href="#section-6.4.2.1" class="section-number selfRef">6.4.2.1. </a><a href="#name-transcript-functions" class="section-name selfRef">Transcript Functions</a>
            </h5>
<p id="section-6.4.2.1-1">The OPAQUE-3DH key derivation procedures make use of the functions below,
re-purposed from TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.<a href="#section-6.4.2.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.2.1-2">
<pre>
Expand-Label(Secret, Label, Context, Length) =
    Expand(Secret, CustomLabel, Length)
</pre><a href="#section-6.4.2.1-2" class="pilcrow">¶</a>
</div>
<p id="section-6.4.2.1-3">Where CustomLabel is specified as:<a href="#section-6.4.2.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.2.1-4">
<pre>
struct {
  uint16 length = Length;
  opaque label&lt;8..255&gt; = "OPAQUE-" + Label;
  uint8 context&lt;0..255&gt; = Context;
} CustomLabel;

Derive-Secret(Secret, Label, Transcript-Hash) =
    Expand-Label(Secret, Label, Transcript-Hash, Nx)
</pre><a href="#section-6.4.2.1-4" class="pilcrow">¶</a>
</div>
<p id="section-6.4.2.1-5">Note that the <code>Label</code> parameter is not a NULL-terminated string.<a href="#section-6.4.2.1-5" class="pilcrow">¶</a></p>
<p id="section-6.4.2.1-6">OPAQUE-3DH can optionally include shared <code>context</code> information in the
transcript, such as configuration parameters or application-specific info, e.g.
"appXYZ-v1.2.3".<a href="#section-6.4.2.1-6" class="pilcrow">¶</a></p>
<p id="section-6.4.2.1-7">The OPAQUE-3DH key schedule requires a preamble, which is computed as follows.<a href="#section-6.4.2.1-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.2.1-8">
<pre>
Preamble

Parameters:
- context, optional shared context information.

Input:
- client_identity, the optional encoded client identity, which is set
  to client_public_key if not specified.
- ke1, a KE1 message structure.
- server_identity, the optional encoded server identity, which is set
  to server_public_key if not specified.
- credential_response, the corresponding field on the KE2 structure.
- server_nonce, the corresponding field on the AuthResponse structure.
- server_keyshare, the corresponding field on the AuthResponse structure.

Output:
- preamble, the protocol transcript with identities and messages.

def Preamble(client_identity, ke1, server_identity, ke2):
  preamble = concat("RFCXXXX",
                     I2OSP(len(context), 2), context,
                     I2OSP(len(client_identity), 2), client_identity,
                     ke1,
                     I2OSP(len(server_identity), 2), server_identity,
                     credential_response,
                     server_nonce,
                     server_keyshare)
  return preamble
</pre><a href="#section-6.4.2.1-8" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="shared-secret-derivation">
<section id="section-6.4.2.2">
            <h5 id="name-shared-secret-derivation">
<a href="#section-6.4.2.2" class="section-number selfRef">6.4.2.2. </a><a href="#name-shared-secret-derivation" class="section-name selfRef">Shared Secret Derivation</a>
            </h5>
<p id="section-6.4.2.2-1">The OPAQUE-3DH shared secret derived during the key exchange protocol is
computed using the following helper function.<a href="#section-6.4.2.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.2.2-2">
<pre>
DeriveKeys

Input:
- ikm, input key material.
- preamble, the protocol transcript with identities and messages.

Output:
- Km2, a MAC authentication key.
- Km3, a MAC authentication key.
- session_key, the shared session secret.

def DeriveKeys(ikm, preamble):
  prk = Extract("", ikm)
  handshake_secret = Derive-Secret(prk, "HandshakeSecret", Hash(preamble))
  session_key = Derive-Secret(prk, "SessionKey", Hash(preamble))
  Km2 = Derive-Secret(handshake_secret, "ServerMAC", "")
  Km3 = Derive-Secret(handshake_secret, "ClientMAC", "")
  return (Km2, Km3, session_key)
</pre><a href="#section-6.4.2.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="ake-client">
<section id="section-6.4.3">
          <h4 id="name-3dh-client-functions">
<a href="#section-6.4.3" class="section-number selfRef">6.4.3. </a><a href="#name-3dh-client-functions" class="section-name selfRef">3DH Client Functions</a>
          </h4>
<p id="section-6.4.3-1">The <code>AuthClientStart</code> function is used by the client to create a
<code>KE1</code> structure.<a href="#section-6.4.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.3-2">
<pre>
AuthClientStart

Parameters:
- Nn, the nonce length.

State:
- state, a ClientAkeState structure.

Input:
- credential_request, a CredentialRequest structure.

Output:
- ke1, a KE1 structure.

def AuthClientStart(credential_request):
  client_nonce = random(Nn)
  (client_secret, client_keyshare) = GenerateAuthKeyPair()
  Create AuthRequest auth_request with (client_nonce, client_keyshare)
  Create KE1 ke1 with (credential_request, auth_request)
  state.client_secret = client_secret
  state.ke1 = ke1
  return ke1
</pre><a href="#section-6.4.3-2" class="pilcrow">¶</a>
</div>
<p id="section-6.4.3-3">The <code>AuthClientFinalize</code> function is used by the client to create a <code>KE3</code>
message and output <code>session_key</code> using the server's <code>KE2</code> message and
recovered credential information.<a href="#section-6.4.3-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.3-4">
<pre>
AuthClientFinalize

State:
- state, a ClientAkeState structure.

Input:
- client_identity, the optional encoded client identity, which is
  set to client_public_key if not specified.
- client_private_key, the client's private key.
- server_identity, the optional encoded server identity, which is
  set to server_public_key if not specified.
- server_public_key, the server's public key.
- ke2, a KE2 message structure.

Output:
- ke3, a KE3 structure.
- session_key, the shared session secret.

Exceptions:
- ServerAuthenticationError, the handshake fails.

def AuthClientFinalize(client_identity, client_private_key, server_identity,
                       server_public_key, ke2):

  dh1 = SerializeElement(state.client_secret * ke2.auth_response.server_keyshare)
  dh2 = SerializeElement(state.client_secret * server_public_key)
  dh3 = SerializeElement(client_private_key  * ke2.auth_response.server_keyshare)
  ikm = concat(dh1, dh2, dh3)

  preamble = Preamble(client_identity,
                      state.ke1,
                      server_identity,
                      ke2.credential_response,
                      ke2.auth_response.server_nonce,
                      ke2.auth_response.server_keyshare)
  Km2, Km3, session_key = DeriveKeys(ikm, preamble)
  expected_server_mac = MAC(Km2, Hash(preamble))
  if !ct_equal(ke2.server_mac, expected_server_mac),
    raise ServerAuthenticationError
  client_mac = MAC(Km3, Hash(concat(preamble, expected_server_mac))
  Create KE3 ke3 with client_mac
  return (ke3, session_key)
</pre><a href="#section-6.4.3-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="ake-server">
<section id="section-6.4.4">
          <h4 id="name-3dh-server-functions">
<a href="#section-6.4.4" class="section-number selfRef">6.4.4. </a><a href="#name-3dh-server-functions" class="section-name selfRef">3DH Server Functions</a>
          </h4>
<p id="section-6.4.4-1">The <code>AuthServerRespond</code> function is used by the server to process the client's
<code>KE1</code> message and public credential information to create a <code>KE2</code> message.<a href="#section-6.4.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.4-2">
<pre>
AuthServerRespond

Parameters:
- Nn, the nonce length.

State:
- state, a ServerAkeState structure.

Input:
- server_identity, the optional encoded server identity, which is set to
  server_public_key if not specified.
- server_private_key, the server's private key.
- client_identity, the optional encoded client identity, which is set to
  client_public_key if not specified.
- client_public_key, the client's public key.
- ke1, a KE1 message structure.

Output:
- auth_response, an AuthResponse structure.

def AuthServerRespond(server_identity, server_private_key, client_identity,
                      client_public_key, ke1, credential_response):
  server_nonce = random(Nn)
  (server_private_keyshare, server_keyshare) = GenerateAuthKeyPair()
  preamble = Preamble(client_identity,
                      ke1,
                      server_identity,
                      credential_response,
                      server_nonce,
                      server_keyshare)

  dh1 = SerializeElement(server_private_keyshare * ke1.auth_request.client_keyshare)
  dh2 = SerializeElement(server_private_key * ke1.auth_request.client_keyshare)
  dh3 = SerializeElement(server_private_keyshare * client_public_key)
  ikm = concat(dh1, dh2, dh3)

  Km2, Km3, session_key = DeriveKeys(ikm, preamble)
  server_mac = MAC(Km2, Hash(preamble))
  expected_client_mac = MAC(Km3, Hash(concat(preamble, server_mac))

  state.expected_client_mac = MAC(Km3, Hash(concat(preamble, server_mac))
  state.session_key = session_key
  Create AuthResponse auth_response with (server_nonce, server_keyshare, server_mac)
  return auth_response
</pre><a href="#section-6.4.4-2" class="pilcrow">¶</a>
</div>
<p id="section-6.4.4-3">The <code>AuthServerFinalize</code> function is used by the server to process the client's
<code>KE3</code> message and output the final <code>session_key</code>.<a href="#section-6.4.4-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-6.4.4-4">
<pre>
AuthServerFinalize

State:
- state, a ServerAkeState structure.

Input:
- ke3, a KE3 structure.

Output:
- session_key, the shared session secret if and only if ke3 is valid.

Exceptions:
- ClientAuthenticationError, the handshake fails.

def AuthServerFinalize(ke3):
  if !ct_equal(ke3.client_mac, state.expected_client_mac):
    raise ClientAuthenticationError
  return state.session_key
</pre><a href="#section-6.4.4-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="configurations">
<section id="section-7">
      <h2 id="name-configurations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-configurations" class="section-name selfRef">Configurations</a>
      </h2>
<p id="section-7-1">An OPAQUE-3DH configuration is a tuple (OPRF, KDF, MAC, Hash, KSF, Group, Context)
such that the following conditions are met:<a href="#section-7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-2.1">The OPRF protocol uses the "base mode" variant of <span>[<a href="#OPRF" class="xref">OPRF</a>]</span> and implements
the interface in <a href="#dependencies" class="xref">Section 2</a>. Examples include OPRF(ristretto255, SHA-512) and
OPRF(P-256, SHA-256).<a href="#section-7-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-2.2">The KDF, MAC, and Hash functions implement the interfaces in <a href="#dependencies" class="xref">Section 2</a>.
Examples include HKDF <span>[<a href="#RFC5869" class="xref">RFC5869</a>]</span> for the KDF, HMAC <span>[<a href="#RFC2104" class="xref">RFC2104</a>]</span> for the MAC,
and SHA-256 and SHA-512 for the Hash functions. If an extensible output function
such as SHAKE128 <span>[<a href="#FIPS202" class="xref">FIPS202</a>]</span> is used then the output length <code>Nh</code> MUST be chosen
to align with the target security level of the OPAQUE configuration. For example,
if the target security parameter for the configuration is 128-bits, then <code>Nh</code> SHOULD be at least 32 bytes.<a href="#section-7-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-2.3">The KSF has fixed parameters, chosen by the application, and implements the
interface in <a href="#dependencies" class="xref">Section 2</a>. Examples include Argon2 <span>[<a href="#ARGON2" class="xref">ARGON2</a>]</span>,
scrypt <span>[<a href="#SCRYPT" class="xref">SCRYPT</a>]</span>, and PBKDF2 <span>[<a href="#PBKDF2" class="xref">PBKDF2</a>]</span> with fixed parameter choices.<a href="#section-7-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-2.4">The Group mode identifies the group used in the OPAQUE-3DH AKE. This SHOULD
match that of the OPRF. For example, if the OPRF is OPRF(ristretto255, SHA-512),
then Group SHOULD be ristretto255.<a href="#section-7-2.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-7-3">Context is the shared parameter used to construct the preamble in <a href="#transcript-functions" class="xref">Section 6.4.2.1</a>.
This parameter SHOULD include any application-specific configuration information or
parameters that are needed to prevent cross-protocol or downgrade attacks.<a href="#section-7-3" class="pilcrow">¶</a></p>
<p id="section-7-4">Absent an application-specific profile, the following configurations are RECOMMENDED:<a href="#section-7-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-5.1">OPRF(ristretto255, SHA-512), HKDF-SHA-512, HMAC-SHA-512, SHA-512, Scrypt(32768,8,1), internal, ristretto255<a href="#section-7-5.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-7-5.2">OPRF(P-256, SHA-256), HKDF-SHA-256, HMAC-SHA-256, SHA-256, Scrypt(32768,8,1), internal, P-256<a href="#section-7-5.2" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-7-6">Future configurations may specify different combinations of dependent algorithms,
with the following considerations:<a href="#section-7-6" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-7-7">
<li id="section-7-7.1">The size of AKE public and private keys -- <code>Npk</code> and <code>Nsk</code>, respectively -- must adhere
to the output length limitations of the KDF Expand function. If HKDF is used, this means
Npk, Nsk &lt;= 255 * Nx, where Nx is the output size of the underlying hash function.
See <span>[<a href="#RFC5869" class="xref">RFC5869</a>]</span> for details.<a href="#section-7-7.1" class="pilcrow">¶</a>
</li>
        <li id="section-7-7.2">The output size of the Hash function SHOULD be long enough to produce a key for
MAC of suitable length. For example, if MAC is HMAC-SHA256, then <code>Nh</code> could be
32 bytes.<a href="#section-7-7.2" class="pilcrow">¶</a>
</li>
      </ol>
</section>
</div>
<div id="app-considerations">
<section id="section-8">
      <h2 id="name-application-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-application-considerations" class="section-name selfRef">Application Considerations</a>
      </h2>
<p id="section-8-1">Beyond choosing an appropriate configuration, there are several parameters which
applications can use to control OPAQUE:<a href="#section-8-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8-2.1">Credential identifier: As described in <a href="#offline-phase" class="xref">Section 5</a>, this is a unique
handle to the client's credential being stored. In applications where there are alternate
client identities that accompany an account, such as a username or email address, this
identifier can be set to those alternate values. For simplicity, applications may choose
to set <code>credential_identifier</code> to be equal to <code>client_identity</code>. Applications
MUST NOT use the same credential identifier for multiple clients.<a href="#section-8-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-8-2.2">Context information: As described in <a href="#configurations" class="xref">Section 7</a>, applications may include
a shared context string that is authenticated as part of the handshake. This parameter
SHOULD include any configuration information or parameters that are needed to prevent
cross-protocol or downgrade attacks. This context information is not sent over the
wire in any key exchange messages. However, applications may choose to send it alongside
key exchange messages if needed for their use case.<a href="#section-8-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-8-2.3">Client and server identities: As described in <a href="#client-material" class="xref">Section 4</a>, clients
and servers are identified with their public keys by default. However, applications
may choose alternate identities that are pinned to these public keys. For example,
servers may use a domain name instead of a public key as their identifier. Absent
alternate notions of an identity, applications SHOULD set these identities to nil
and rely solely on public key information.<a href="#section-8-2.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-8-2.4">Enumeration prevention: As described in <a href="#create-credential-response" class="xref">Section 6.3.2.2</a>, if servers
receive a credential request for a non-existent client, they SHOULD respond with a
"fake" response in order to prevent active client enumeration attacks. Servers that
implement this mitigation SHOULD use the same configuration information (such as
the oprf_seed) for all clients; see <a href="#preventing-client-enumeration" class="xref">Section 10.9</a>. In settings
where this attack is not a concern, servers may choose to not support this functionality.<a href="#section-8-2.4" class="pilcrow">¶</a>
</li>
      </ul>
</section>
</div>
<div id="implementation-considerations">
<section id="section-9">
      <h2 id="name-implementation-consideratio">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-implementation-consideratio" class="section-name selfRef">Implementation Considerations</a>
      </h2>
<p id="section-9-1">This section documents considerations for OPAQUE implementations. This includes
implementation safeguards and error handling considerations.<a href="#section-9-1" class="pilcrow">¶</a></p>
<div id="implementation-safeguards">
<section id="section-9.1">
        <h3 id="name-implementation-safeguards">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-implementation-safeguards" class="section-name selfRef">Implementation Safeguards</a>
        </h3>
<p id="section-9.1-1">Certain information created, exchanged, and processed in OPAQUE is sensitive.
Specifically, all private key material and intermediate values, along with the
outputs of the key exchange phase, are all secret. Implementations should not
retain these values in memory when no longer needed. Moreover, all operations,
particularly the cryptographic and group arithmetic operations, should be
constant-time and independent of the bits of any secrets. This includes any
conditional branching during the creation of the credential response, as needed
to mitigate against client enumeration attacks.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<p id="section-9.1-2">As specified in <a href="#offline-phase" class="xref">Section 5</a> and <a href="#online-phase" class="xref">Section 6</a>, OPAQUE only requires
the client password as input to the OPRF for registration and authentication.
However, implementations can incorporate the client identity alongside the
password as input to the OPRF. This provides additional client-side entropy
which can supplement the entropy that should be introduced by the server during
an honest execution of the protocol. This also provides domain separation
between different clients that might otherwise share the same password.<a href="#section-9.1-2" class="pilcrow">¶</a></p>
<p id="section-9.1-3">Finally, note that online guessing attacks (against any aPAKE) can be done from
both the client side and the server side. In particular, a malicious server can
attempt to simulate honest responses in order to learn the client's password.
Implementations and deployments of OPAQUE SHOULD consider additional checks to
mitigate this type of attack: for instance, by ensuring that there is a
server-authenticated channel over which OPAQUE registration and login is run.<a href="#section-9.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="error-considerations">
<section id="section-9.2">
        <h3 id="name-error-considerations">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-error-considerations" class="section-name selfRef">Error Considerations</a>
        </h3>
<p id="section-9.2-1">Some functions included in this specification are fallible. For example, the
authenticated key exchange protocol may fail because the client's password was
incorrect or the authentication check failed, yielding an error. The explicit
errors generated throughout this specifiation, along with conditions that lead
to each error, are as follows:<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.2-2.1">EnvelopeRecoveryError: The envelope Recover function failed to produce any
authentication key material; <a href="#envelope-recovery" class="xref">Section 4.1.3</a>.<a href="#section-9.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.2-2.2">ServerAuthenticationError: The client failed to complete the authenticated
key exchange protocol with the server; <a href="#ake-client" class="xref">Section 6.4.3</a>.<a href="#section-9.2-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-9.2-2.3">ClientAuthenticationError: The server failed to complete the authenticated
key exchange protocol with the client; <a href="#ake-server" class="xref">Section 6.4.4</a>.<a href="#section-9.2-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-9.2-3">Beyond these explicit errors, OPAQUE implementations can produce implicit errors.
For example, if protocol messages sent between client and server do not match
their expected size, an implementaton should produce an error. More generally,
if any protocol message received from the peer is invalid, perhaps because the
message contains an invalid public key (indicated by the AKE DeserializeElement
function failing) or an invalid OPRF element (indicated by the OPRF DeserializeElement),
then an implementation should produce an error.<a href="#section-9.2-3" class="pilcrow">¶</a></p>
<p id="section-9.2-4">The errors in this document are meant as a guide for implementors. They are not an
exhaustive list of all the errors an implementation might emit. For example, an
implementation might run out of memory.<a href="#section-9.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-10">
      <h2 id="name-security-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-10-1">OPAQUE is defined as the composition of two functionalities: an OPRF and
an AKE protocol. It can be seen as a "compiler" for transforming any AKE
protocol (with KCI security and forward secrecy; see below)
into a secure aPAKE protocol. In OPAQUE, the client stores a secret private key at the
server during password registration and retrieves this key each time
it needs to authenticate to the server. The OPRF security properties
ensure that only the correct password can unlock the private key
while at the same time avoiding potential offline guessing attacks.
This general composability property provides great flexibility and
enables a variety of OPAQUE instantiations, from optimized
performance to integration with existing authenticated key exchange
protocols such as TLS.<a href="#section-10-1" class="pilcrow">¶</a></p>
<div id="notable-design-differences">
<section id="section-10.1">
        <h3 id="name-notable-design-differences">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-notable-design-differences" class="section-name selfRef">Notable Design Differences</a>
        </h3>
<p id="section-10.1-1">[[RFC EDITOR: Please delete this section before publication.]]<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<p id="section-10.1-2">The specification as written here differs from the original cryptographic design in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>
and the corresponding CFRG document <span>[<a href="#I-D.krawczyk-cfrg-opaque-03" class="xref">I-D.krawczyk-cfrg-opaque-03</a>]</span>, both of which were used
as input to the CFRG PAKE competition. This section describes these differences, including
their motivation and explanation as to why they preserve the provable security of OPAQUE based
on <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>.<a href="#section-10.1-2" class="pilcrow">¶</a></p>
<p id="section-10.1-3">The following list enumerates important functional differences that were made
as part of the protocol specification process to address application or
implementation considerations.<a href="#section-10.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1-4.1">Clients construct envelope contents without revealing the password to the
server, as described in <a href="#offline-phase" class="xref">Section 5</a>, whereas the servers construct
envelopes in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>. This change adds to the security of the protocol.
<span>[<a href="#JKX18" class="xref">JKX18</a>]</span> considered the case where the envelope was constructed by the
server for reasons of compatibility with previous UC modeling. An upcoming
paper analyzes the registration phase as specified in this document. This
change was made to support registration flows where the client chooses the
password and wishes to keep it secret from the server, and it is compatible
with the variant in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> that was originally analyzed.<a href="#section-10.1-4.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.2">Envelopes do not contain encrypted credentials. Instead, envelopes contain
information used to derive client private key material for the AKE. This
variant is also analyzed in the new paper referred to in the previous item.
This change improves the assumption behind the protocol by getting rid of
equivocability and random key robustness for the encryption function. The
latter property is only required for authentication and achieved by a
collision-resistant MAC. This change was made for two reasons. First, it
reduces the number of bytes stored in envelopes, which is an helpful
improvement for large applications of OPAQUE with many registered users.
Second, it removes the need for client applications to generate authentication
keys during registration. Instead, this responsibility is handled by OPAQUE,
thereby simplifying the client interface to the protocol.<a href="#section-10.1-4.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.3">Envelopes are masked with a per-user masking key as a way of preventing
client enumeration attacks. See <a href="#preventing-client-enumeration" class="xref">Section 10.9</a> for more
details. This extension is not needed for the security of OPAQUE as an aPAKE
but only used to provide a defense against enumeration attacks. In the
analysis, the masking key can be simulated as a (pseudo) random key. This
change was made to support real-world use cases where client or user
enumeration is a security (or privacy) risk.<a href="#section-10.1-4.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.4">Per-user OPRF keys are derived from a client identity and cross-user PRF seed
as a mitigation against client enumeration attacks. See
<a href="#preventing-client-enumeration" class="xref">Section 10.9</a> for more details. The analysis of OPAQUE
assumes OPRF keys of different users are independently random or
pseudorandom. Deriving these keys via a single PRF (i.e., with a single
cross-user key) applied to users' identities satisfies this assumption.
This change was made to support real-world use cases where client or user
enumeration is a security (or privacy) risk.<a href="#section-10.1-4.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.5">The protocol outputs an export key for the client in addition to shared
session key that can be used for application-specific purposes. This key
is a pseudorandom value independent of other values in the protocol and
has no influence in the security analysis (it can be simulated with a
random output). This change was made to support more application use cases
for OPAQUE, such as use of OPAQUE for end-to-end encrypted backups;
see <span>[<a href="#WhatsAppE2E" class="xref">WhatsAppE2E</a>]</span>.<a href="#section-10.1-4.5" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.6">The protocol admits optional application-layer client and server identities.
In the absence of these identities, client and server are authenticated
against their public keys. Binding authentication to identities is part
of the AKE part of OPAQUE. The type of identities and their semantics
are application dependent and independent of the protocol analysis. This
change was made to simplify client and server interfaces to the protocol
by removing the need to specify additional identities alongside their
corresponding public authentication keys when not needed.<a href="#section-10.1-4.6" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.7">The protocol admits application-specific context information configured
out-of-band in the AKE transcript. This allows domain separation between
different application uses of OPAQUE. This is a mechanism for the AKE
component and is best practice as for domain separation between different
applications of the protocol. This change was made to allow different
applications to use OPAQUE without risk of cross-protocol attacks.<a href="#section-10.1-4.7" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-4.8">Servers use a separate identifier for computing OPRF evaluations and
indexing into the password file storage, called the credential_identifier.
This allows clients to change their application-layer identity
(client_identity) without inducing server-side changes, e.g., by changing
an email address associated with a given account. This mechanism is part
of the derivation of OPRF keys via a single PRF. As long as the derivation
of different OPRF keys from a single OPRF have different PRF inputs, the
protocol is secure. The choice of such inputs is up to the application.<a href="#section-10.1-4.8" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-10.1-5">The following list enumerates notable differences and refinements from the original
cryptographic design in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> and the corresponding CFRG document
<span>[<a href="#I-D.krawczyk-cfrg-opaque-03" class="xref">I-D.krawczyk-cfrg-opaque-03</a>]</span> that were made to make this specification
suitable for interoperable implementations.<a href="#section-10.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1-6.1">
            <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> used a generic prime-order group for the DH-OPRF and HMQV operations,
and includes necessary prime-order subgroup checks when receiving attacker-controlled
values over the wire. This specification instantiates the prime-order group using for
3DH using prime-order groups based on elliptic curves, as described in
<span>[<a href="#I-D.irtf-cfrg-voprf" class="xref">I-D.irtf-cfrg-voprf</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10#section-2.1" class="relref">Section 2.1</a></span>. This specification also delegates OPRF group
choice and operations to <span>[<a href="#I-D.irtf-cfrg-voprf" class="xref">I-D.irtf-cfrg-voprf</a>]</span>. As such, the prime-order group as used
in the OPRF and 3DH as specified in this document both adhere to the requirements as
<span>[<a href="#JKX18" class="xref">JKX18</a>]</span>.<a href="#section-10.1-6.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-6.2">
            <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> specified DH-OPRF (see Appendix B) to instantiate
the OPRF functionality in the protocol. A critical part of DH-OPRF is the
hash-to-group operation, which was not instantiated in the original analysis.
However, the requirements for this operation were included. This specification
instantiates the OPRF functionality based on the <span>[<a href="#I-D.irtf-cfrg-voprf" class="xref">I-D.irtf-cfrg-voprf</a>]</span>, which
is identical to the DH-OPRF functionality in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> and, concretely, uses
the hash-to-curve functions in <span>[<a href="#I-D.irtf-cfrg-hash-to-curve" class="xref">I-D.irtf-cfrg-hash-to-curve</a>]</span>. All hash-to-curve
methods in <span>[<a href="#I-D.irtf-cfrg-hash-to-curve" class="xref">I-D.irtf-cfrg-hash-to-curve</a>]</span> are compliant with the requirement
in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>, namely, that the output be a member of the prime-order group.<a href="#section-10.1-6.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-6.3">
            <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> and <span>[<a href="#I-D.krawczyk-cfrg-opaque-03" class="xref">I-D.krawczyk-cfrg-opaque-03</a>]</span> both used HMQV as the AKE
for the protocol. However, this document fully specifies 3DH instead of HMQV
(though a sketch for how to instantiate OPAQUE using HMQV is included in <a href="#hmqv-sketch" class="xref">Appendix C.1</a>).
Since 3DH satisfies the essential requirements for the AKE as described in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>
and <span>[<a href="#I-D.krawczyk-cfrg-opaque-03" class="xref">I-D.krawczyk-cfrg-opaque-03</a>]</span>, as recalled in <a href="#security-analysis" class="xref">Section 10.2</a>, this change
preserves the overall security of the protocol. 3DH was chosen for its
simplicity and ease of implementation.<a href="#section-10.1-6.3" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-6.4">The DH-OPRF and HMQV instantiation of OPAQUE in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>, Figure 12 uses
a different transcript than that which is described in this specification. In particular,
the key exchange transcript specified in <a href="#ake-protocol" class="xref">Section 6.4</a> is a superset of the transcript
as defined in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>. This was done to align with best practices, such as is
done for key exchange protocols like TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.<a href="#section-10.1-6.4" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-10.1-6.5">Neither <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> nor <span>[<a href="#I-D.krawczyk-cfrg-opaque-03" class="xref">I-D.krawczyk-cfrg-opaque-03</a>]</span> included wire format details for the
protocol, which is essential for interoperability. This specification fills this
gap by including such wire format details and corresponding test vectors; see <a href="#test-vectors" class="xref">Appendix D</a>.<a href="#section-10.1-6.5" class="pilcrow">¶</a>
</li>
        </ul>
</section>
</div>
<div id="security-analysis">
<section id="section-10.2">
        <h3 id="name-security-analysis">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-security-analysis" class="section-name selfRef">Security Analysis</a>
        </h3>
<p id="section-10.2-1">Jarecki et al. <span>[<a href="#JKX18" class="xref">JKX18</a>]</span> proved the security of OPAQUE
in a strong aPAKE model that ensures security against pre-computation attacks
and is formulated in the Universal Composability (UC) framework <span>[<a href="#Canetti01" class="xref">Canetti01</a>]</span>
under the random oracle model. This assumes security of the OPRF
function and the underlying key exchange protocol. In turn, the
security of the OPRF protocol from <span>[<a href="#OPRF" class="xref">OPRF</a>]</span> is proven
in the random oracle model under the One-More Diffie-Hellman assumption <span>[<a href="#JKKX16" class="xref">JKKX16</a>]</span>.<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<p id="section-10.2-2">OPAQUE's design builds on a line of work initiated in the seminal
paper of Ford and Kaliski <span>[<a href="#FK00" class="xref">FK00</a>]</span> and is based on the HPAKE protocol
of Xavier Boyen <span>[<a href="#Boyen09" class="xref">Boyen09</a>]</span> and the (1,1)-PPSS protocol from Jarecki
et al. <span>[<a href="#JKKX16" class="xref">JKKX16</a>]</span>. None of these papers considered security against
pre-computation attacks or presented a proof of aPAKE security
(not even in a weak model).<a href="#section-10.2-2" class="pilcrow">¶</a></p>
<p id="section-10.2-3">The KCI property required from AKE protocols for use with OPAQUE
states that knowledge of a party's private key does not allow an attacker
to impersonate others to that party. This is an important security
property achieved by most public-key based AKE protocols, including
protocols that use signatures or public key encryption for
authentication. It is also a property of many implicitly
authenticated protocols, e.g., HMQV, but not all of them. We also note that
key exchange protocols based on shared keys do not satisfy the KCI
requirement, hence they are not considered in the OPAQUE setting.
We note that KCI is needed to ensure a crucial property of OPAQUE: even upon
compromise of the server, the attacker cannot impersonate the client to the
server without first running an exhaustive dictionary attack.
Another essential requirement from AKE protocols for use in OPAQUE is to
provide forward secrecy (against active attackers).<a href="#section-10.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="related-protocols">
<section id="section-10.3">
        <h3 id="name-related-protocols">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-related-protocols" class="section-name selfRef">Related Protocols</a>
        </h3>
<p id="section-10.3-1">Despite the existence of multiple designs for (PKI-free) aPAKE protocols,
none of these protocols are secure against pre-computation attacks.
This includes protocols that have recent analyses in the UC model such
as AuCPace <span>[<a href="#AuCPace" class="xref">AuCPace</a>]</span> and SPAKE2+ <span>[<a href="#SPAKE2plus" class="xref">SPAKE2plus</a>]</span>. In particular, none
of these protocols can use the standard technique against pre-computation
that combines secret random values ("salt") into the one-way password mappings.
Either these protocols do not use a salt at all or, if they do, they
transmit the salt from server to client in the clear, hence losing the
secrecy of the salt and its defense against pre-computation.<a href="#section-10.3-1" class="pilcrow">¶</a></p>
<p id="section-10.3-2">We note that as shown in <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>, these protocols, and any aPAKE
in the model from <span>[<a href="#GMR06" class="xref">GMR06</a>]</span>, can be converted into an aPAKE secure against
pre-computation attacks at the expense of an additional OPRF execution.<a href="#section-10.3-2" class="pilcrow">¶</a></p>
<p id="section-10.3-3">Beyond AuCPace and SPAKE2+, the most widely deployed PKI-free aPAKE is SRP <span>[<a href="#RFC2945" class="xref">RFC2945</a>]</span>,
which is vulnerable to pre-computation attacks, lacks proof of security, and is
less efficient than OPAQUE. Moreover, SRP requires a ring as it mixes addition and
multiplication operations, and thus does not work over standard elliptic curves.
OPAQUE is therefore a suitable replacement for applications that use SRP.<a href="#section-10.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="identities">
<section id="section-10.4">
        <h3 id="name-identities">
<a href="#section-10.4" class="section-number selfRef">10.4. </a><a href="#name-identities" class="section-name selfRef">Identities</a>
        </h3>
<p id="section-10.4-1">AKE protocols generate keys that need to be uniquely and verifiably bound to a pair
of identities. In the case of OPAQUE, those identities correspond to client_identity and server_identity.
Thus, it is essential for the parties to agree on such identities, including an
agreed bit representation of these identities as needed.<a href="#section-10.4-1" class="pilcrow">¶</a></p>
<p id="section-10.4-2">Applications may have different policies about how and when identities are
determined. A natural approach is to tie client_identity to the identity the server uses
to fetch envelope (hence determined during password registration) and to tie server_identity
to the server identity used by the client to initiate an offline password
registration or online authenticated key exchange session. server_identity and client_identity can also
be part of the envelope or be tied to the parties' public keys. In principle, identities
may change across different sessions as long as there is a policy that
can establish if the identity is acceptable or not to the peer. However, we note
that the public keys of both the server and the client must always be those defined
at the time of password registration.<a href="#section-10.4-2" class="pilcrow">¶</a></p>
<p id="section-10.4-3">The client identity (client_identity) and server identity (server_identity) are
optional parameters that are left to the application to designate as aliases for
the client and server. If the application layer does not supply values for these
parameters, then they will be omitted from the creation of the envelope
during the registration stage. Furthermore, they will be substituted with
client_identity = client_public_key and server_identity = server_public_key during
the authenticated key exchange stage.<a href="#section-10.4-3" class="pilcrow">¶</a></p>
<p id="section-10.4-4">The advantage to supplying a custom client_identity and server_identity (instead of simply relying
on a fallback to client_public_key and server_public_key) is that the client can then ensure that any
mappings between client_identity and client_public_key (and server_identity and server_public_key)
are protected by the authentication from the envelope. Then, the client can verify that the
client_identity and server_identity contained in its envelope match the client_identity
and server_identity supplied by the server.<a href="#section-10.4-4" class="pilcrow">¶</a></p>
<p id="section-10.4-5">However, if this extra layer of verification is unnecessary for the application, then simply
leaving client_identity and server_identity unspecified (and using client_public_key and
server_public_key instead) is acceptable.<a href="#section-10.4-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="export-key-usage">
<section id="section-10.5">
        <h3 id="name-export-key-usage">
<a href="#section-10.5" class="section-number selfRef">10.5. </a><a href="#name-export-key-usage" class="section-name selfRef">Export Key Usage</a>
        </h3>
<p id="section-10.5-1">The export key can be used (separately from the OPAQUE protocol) to provide
confidentiality and integrity to other data which only the client should be
able to process. For instance, if the server is expected to maintain any
client-side secrets which require a password to access, then this export key
can be used to encrypt these secrets so that they remain hidden from the
server.<a href="#section-10.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="static-diffie-hellman-oracles">
<section id="section-10.6">
        <h3 id="name-static-diffie-hellman-oracl">
<a href="#section-10.6" class="section-number selfRef">10.6. </a><a href="#name-static-diffie-hellman-oracl" class="section-name selfRef">Static Diffie-Hellman Oracles</a>
        </h3>
<p id="section-10.6-1">While one can expect the practical security of the OPRF function (namely,
the hardness of computing the function without knowing the key) to be in the
order of computing discrete logarithms or solving Diffie-Hellman, Brown and
Gallant <span>[<a href="#BG04" class="xref">BG04</a>]</span> and Cheon <span>[<a href="#Cheon06" class="xref">Cheon06</a>]</span> show an attack that slightly improves
on generic attacks. For typical curves, the attack requires an infeasible
number of calls to the OPRF or results in insignificant security loss;
see <span>[<a href="#OPRF" class="xref">OPRF</a>]</span> for more information. For OPAQUE, these attacks
are particularly impractical as they translate into an infeasible number of
failed authentication attempts directed at individual users.<a href="#section-10.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="validation">
<section id="section-10.7">
        <h3 id="name-input-validation">
<a href="#section-10.7" class="section-number selfRef">10.7. </a><a href="#name-input-validation" class="section-name selfRef">Input Validation</a>
        </h3>
<p id="section-10.7-1">Both client and server MUST validate the other party's public key(s) used
for the execution of OPAQUE. This includes the keys shared during the
offline registration phase, as well as any keys shared during the online
key agreement phase. The validation procedure varies depending on the
type of key. For example, for OPAQUE instantiations
using 3DH with P-256, P-384, or P-521 as the underlying group, validation
is as specified in Section 5.6.2.3.4 of <span>[<a href="#keyagreement" class="xref">keyagreement</a>]</span>. This includes
checking that the coordinates are in the correct range, that the point
is on the curve, and that the point is not the point at infinity.
Additionally, validation MUST ensure the Diffie-Hellman shared secret is
not the point at infinity.<a href="#section-10.7-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="oprf-key-stretching">
<section id="section-10.8">
        <h3 id="name-oprf-key-stretching">
<a href="#section-10.8" class="section-number selfRef">10.8. </a><a href="#name-oprf-key-stretching" class="section-name selfRef">OPRF Key Stretching</a>
        </h3>
<p id="section-10.8-1">Applying a key streching function to the output of the OPRF greatly increases the cost of an offline
attack upon the compromise of the credential file at the server. Applications
SHOULD select parameters that balance cost and complexity. Note that in
OPAQUE, the key stretching function is executed by the client, as opposed to
the server. This means that applications must consider a tradeoff between the
performance of the protocol on clients (specifically low-end devices) and
protection against offline attacks after a server compromise.<a href="#section-10.8-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="preventing-client-enumeration">
<section id="section-10.9">
        <h3 id="name-client-enumeration">
<a href="#section-10.9" class="section-number selfRef">10.9. </a><a href="#name-client-enumeration" class="section-name selfRef">Client Enumeration</a>
        </h3>
<p id="section-10.9-1">Client enumeration refers to attacks where the attacker tries to learn
extra information about the behavior of clients that have registered with
the server. There are two types of attacks we consider:<a href="#section-10.9-1" class="pilcrow">¶</a></p>
<p id="section-10.9-2">1) An attacker tries to learn whether a given client identity is registered
with a server, and
2) An attacker tries to learn whether a given client identity has recently
completed registration, re-registered (e.g. after a password change), or
changed its identity.<a href="#section-10.9-2" class="pilcrow">¶</a></p>
<p id="section-10.9-3">OPAQUE prevents these attacks during the authentication flow. The first is
prevented by requiring servers to act with unregistered client identities in a
way that is indistinguishable from its behavior with existing registered clients.
Servers do this by simulating a fake CredentialResponse as specified in
<a href="#create-credential-response" class="xref">Section 6.3.2.2</a> for unregistered users, and also encrypting both
CredentialResponse using a masking key. In this way, real and fake CredentialResponse
messages are indistinguishable from one another.
Implementations must also take care to avoid side-channel leakage (e.g., timing
attacks) from helping differentiate these operations from a regular server
response. Note that this may introduce possible abuse vectors since the
server's cost of generating a CredentialResponse is less than that of the
client's cost of generating a CredentialRequest. Server implementations
may choose to forego the construction of a simulated credential response
message for an unregistered client if these client enumeration attacks can
be mitigated through other application-specific means or are otherwise not
applicable for their threat model.<a href="#section-10.9-3" class="pilcrow">¶</a></p>
<p id="section-10.9-4">Preventing the second type of attack requires the server to supply a
credential_identifier value for a given client identity, consistently between
the registration response and credential response; see <a href="#create-reg-response" class="xref">Section 5.2.2</a>
and <a href="#create-credential-response" class="xref">Section 6.3.2.2</a>. Note that credential_identifier can be set
to client_identity for simplicity.<a href="#section-10.9-4" class="pilcrow">¶</a></p>
<p id="section-10.9-5">In the event of a server compromise that results in a re-registration of
credentials for all compromised clients, the oprf_seed value MUST be resampled,
resulting in a change in the oprf_key value for each client. Although this
change can be detected by an adversary, it is only leaked upon password rotation
after the exposure of the credential files, and equally affects all registered
clients.<a href="#section-10.9-5" class="pilcrow">¶</a></p>
<p id="section-10.9-6">Finally, applications must use the same key recovery mechanism when using this
prevention throughout their lifecycle. The envelope size may vary between
mechanisms, so a switch could then be detected.<a href="#section-10.9-6" class="pilcrow">¶</a></p>
<p id="section-10.9-7">OPAQUE does not prevent either type of attack during the registration flow.
Servers necessarily react differently during the registration flow between
registered and unregistered clients. This allows an attacker to use the server's
response during registration as an oracle for whether a given client identity is
registered. Applications should mitigate against this type of attack by rate
limiting or otherwise restricting the registration flow.<a href="#section-10.9-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="password-salt-and-storage-implications">
<section id="section-10.10">
        <h3 id="name-password-salt-and-storage-i">
<a href="#section-10.10" class="section-number selfRef">10.10. </a><a href="#name-password-salt-and-storage-i" class="section-name selfRef">Password Salt and Storage Implications</a>
        </h3>
<p id="section-10.10-1">In OPAQUE, the OPRF key acts as the secret salt value that ensures the infeasibility
of pre-computation attacks. No extra salt value is needed. Also, clients never
disclose their passwords to the server, even during registration. Note that a corrupted
server can run an exhaustive offline dictionary attack to validate guesses for the client's
password; this is inevitable in any aPAKE protocol. (OPAQUE enables defense against such
offline dictionary attacks by distributing the server so that an offline attack is only
possible if all - or a minimal number of - servers are compromised <span>[<a href="#JKX18" class="xref">JKX18</a>]</span>.) Furthermore,
if the server does not sample this OPRF key with sufficiently high entropy, or if it is not
kept hidden from an adversary, then any derivatives from the client's password may also be
susceptible to an offline dictionary attack to recover the original password.<a href="#section-10.10-1" class="pilcrow">¶</a></p>
<p id="section-10.10-2">Some applications may require learning the client's password for enforcing password
rules. Doing so invalidates this important security property of OPAQUE and is
NOT RECOMMENDED. Applications should move such checks to the client. Note that
limited checks at the server are possible to implement, e.g., detecting repeated
passwords.<a href="#section-10.10-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ake-private-key-storage">
<section id="section-10.11">
        <h3 id="name-ake-private-key-storage">
<a href="#section-10.11" class="section-number selfRef">10.11. </a><a href="#name-ake-private-key-storage" class="section-name selfRef">AKE Private Key Storage</a>
        </h3>
<p id="section-10.11-1">Server implementations of OPAQUE do not need access to the raw AKE private key. They only require
the ability to compute shared secrets as specified in <a href="#key-schedule-functions" class="xref">Section 6.4.2</a>. Thus, applications
may store the server AKE private key in a Hardware Security Module (HSM) or
similar. Upon compromise of the OPRF seed and client envelopes, this would prevent an
attacker from using this data to mount a server spoofing attack. Supporting implementations
need to consider allowing separate AKE and OPRF algorithms in cases where the HSM is
incompatible with the OPRF algorithm.<a href="#section-10.11-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-11">
      <h2 id="name-iana-considerations">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-11-1">This document makes no IANA requests.<a href="#section-11-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-12">
      <h2 id="name-references">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-12.1">
        <h3 id="name-normative-references">
<a href="#section-12.1" class="section-number selfRef">12.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.irtf-cfrg-voprf">[I-D.irtf-cfrg-voprf]</dt>
        <dd>
<span class="refAuthor">Davidson, A.</span>, <span class="refAuthor">Faz-Hernandez, A.</span>, <span class="refAuthor">Sullivan, N.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-voprf-10</span>, <time datetime="2022-06-30" class="refDate">30 June 2022</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10">https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="OPRF">[OPRF]</dt>
        <dd>
<span class="refAuthor">Davidson, A.</span>, <span class="refAuthor">Faz-Hernandez, A.</span>, <span class="refAuthor">Sullivan, N.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Oblivious Pseudorandom Functions (OPRFs) using Prime-Order Groups"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-voprf-10</span>, <time datetime="2022-06-30" class="refDate">30 June 2022</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10">https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-voprf-10</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2104">[RFC2104]</dt>
        <dd>
<span class="refAuthor">Krawczyk, H.</span>, <span class="refAuthor">Bellare, M.</span>, and <span class="refAuthor">R. Canetti</span>, <span class="refTitle">"HMAC: Keyed-Hashing for Message Authentication"</span>, <span class="seriesInfo">RFC 2104</span>, <span class="seriesInfo">DOI 10.17487/RFC2104</span>, <time datetime="1997-02" class="refDate">February 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2104">https://www.rfc-editor.org/rfc/rfc2104</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4086">[RFC4086]</dt>
        <dd>
<span class="refAuthor">Eastlake 3rd, D.</span>, <span class="refAuthor">Schiller, J.</span>, and <span class="refAuthor">S. Crocker</span>, <span class="refTitle">"Randomness Requirements for Security"</span>, <span class="seriesInfo">BCP 106</span>, <span class="seriesInfo">RFC 4086</span>, <span class="seriesInfo">DOI 10.17487/RFC4086</span>, <time datetime="2005-06" class="refDate">June 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc4086">https://www.rfc-editor.org/rfc/rfc4086</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
      <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-12.2">
        <h3 id="name-informative-references">
<a href="#section-12.2" class="section-number selfRef">12.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="ARGON2">[ARGON2]</dt>
        <dd>
<span class="refAuthor">Biryukov, A.</span>, <span class="refAuthor">Dinu, D.</span>, <span class="refAuthor">Khovratovich, D.</span>, and <span class="refAuthor">S. Josefsson</span>, <span class="refTitle">"Argon2 Memory-Hard Function for Password Hashing and Proof-of-Work Applications"</span>, <span class="seriesInfo">RFC 9106</span>, <span class="seriesInfo">DOI 10.17487/RFC9106</span>, <time datetime="2021-09" class="refDate">September 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9106">https://www.rfc-editor.org/rfc/rfc9106</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="AuCPace">[AuCPace]</dt>
        <dd>
<span class="refAuthor">Haase, B.</span> and <span class="refAuthor">B. Labrique</span>, <span class="refTitle">"AuCPace: Efficient verifier-based PAKE protocol tailored for the IIoT"</span>, <span class="seriesInfo">http://eprint.iacr.org/2018/286 </span>, <time datetime="2018" class="refDate">2018</time>. </dd>
<dd class="break"></dd>
<dt id="BG04">[BG04]</dt>
        <dd>
<span class="refAuthor">Brown, D.</span> and <span class="refAuthor">R. Galant</span>, <span class="refTitle">"The static Diffie-Hellman problem"</span>, <span class="seriesInfo">http://eprint.iacr.org/2004/306 </span>, <time datetime="2004" class="refDate">2004</time>. </dd>
<dd class="break"></dd>
<dt id="Boyen09">[Boyen09]</dt>
        <dd>
<span class="refAuthor">Boyen, X.</span>, <span class="refTitle">"HPAKE: Password Authentication Secure against Cross-Site User Impersonation"</span>, <span class="seriesInfo">Cryptology and Network Security (CANS) </span>, <time datetime="2009" class="refDate">2009</time>. </dd>
<dd class="break"></dd>
<dt id="Canetti01">[Canetti01]</dt>
        <dd>
<span class="refAuthor">Canetti, R.</span>, <span class="refTitle">"Universally composable security: A new paradigm for cryptographic protocols"</span>, <span class="seriesInfo">IEEE Symposium on Foundations of Computer Science (FOCS) </span>, <time datetime="2001" class="refDate">2001</time>. </dd>
<dd class="break"></dd>
<dt id="Cheon06">[Cheon06]</dt>
        <dd>
<span class="refAuthor">Cheon, J. H.</span>, <span class="refTitle">"Security analysis of the strong Diffie-Hellman problem"</span>, <span class="seriesInfo">Euroctypt 2006 </span>, <time datetime="2006" class="refDate">2006</time>. </dd>
<dd class="break"></dd>
<dt id="FIPS202">[FIPS202]</dt>
        <dd>
<span class="refAuthor">National Institute of Standards and Technology (NIST)</span>, <span class="refTitle">"SHA-3 Standard: Permutation-Based Hash and Extendable-Output Functions"</span>, <time datetime="2015-08" class="refDate">August 2015</time>, <span>&lt;<a href="https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf">https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.202.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="FK00">[FK00]</dt>
        <dd>
<span class="refAuthor">Ford, W.</span> and <span class="refAuthor">B. S. Kaliski, Jr</span>, <span class="refTitle">"Server-assisted generation of a strong secret from a password"</span>, <span class="seriesInfo">WETICE </span>, <time datetime="2000" class="refDate">2000</time>. </dd>
<dd class="break"></dd>
<dt id="GMR06">[GMR06]</dt>
        <dd>
<span class="refAuthor">Gentry, C.</span>, <span class="refAuthor">MacKenzie, P.</span>, and <span class="refAuthor">Z, Ramzan</span>, <span class="refTitle">"A method for making password-based key exchange resilient to server compromise"</span>, <span class="seriesInfo">CRYPTO </span>, <time datetime="2006" class="refDate">2006</time>. </dd>
<dd class="break"></dd>
<dt id="HMQV">[HMQV]</dt>
        <dd>
<span class="refAuthor">Krawczyk, H.</span>, <span class="refTitle">"HMQV: A high-performance secure Diffie-Hellman protocol"</span>, <span class="seriesInfo">CRYPTO </span>, <time datetime="2005" class="refDate">2005</time>. </dd>
<dd class="break"></dd>
<dt id="I-D.irtf-cfrg-hash-to-curve">[I-D.irtf-cfrg-hash-to-curve]</dt>
        <dd>
<span class="refAuthor">Faz-Hernandez, A.</span>, <span class="refAuthor">Scott, S.</span>, <span class="refAuthor">Sullivan, N.</span>, <span class="refAuthor">Wahby, R. S.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Hashing to Elliptic Curves"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-hash-to-curve-16</span>, <time datetime="2022-06-15" class="refDate">15 June 2022</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-hash-to-curve-16">https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-hash-to-curve-16</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.krawczyk-cfrg-opaque-03">[I-D.krawczyk-cfrg-opaque-03]</dt>
        <dd>
<span class="refTitle">"The OPAQUE Asymmetric PAKE Protocol"</span>, <span>n.d.</span>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-krawczyk-cfrg-opaque-03">https://datatracker.ietf.org/doc/html/draft-krawczyk-cfrg-opaque-03</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="JKKX16">[JKKX16]</dt>
        <dd>
<span class="refAuthor">Jarecki, S.</span>, <span class="refAuthor">Kiayias, A.</span>, <span class="refAuthor">Krawczyk, H.</span>, and <span class="refAuthor">J. Xu</span>, <span class="refTitle">"Highly-efficient and composable password-protected secret sharing (or: how to protect your bitcoin wallet online)"</span>, <span class="seriesInfo">IEEE European Symposium on Security and Privacy </span>, <time datetime="2016" class="refDate">2016</time>. </dd>
<dd class="break"></dd>
<dt id="JKX18">[JKX18]</dt>
        <dd>
<span class="refAuthor">Jarecki, S.</span>, <span class="refAuthor">Krawczyk, H.</span>, and <span class="refAuthor">J. Xu</span>, <span class="refTitle">"OPAQUE: An Asymmetric PAKE Protocol Secure Against Pre-Computation Attacks"</span>, <span class="seriesInfo">Eurocrypt </span>, <time datetime="2018" class="refDate">2018</time>. </dd>
<dd class="break"></dd>
<dt id="keyagreement">[keyagreement]</dt>
        <dd>
<span class="refAuthor">Barker, E.</span>, <span class="refAuthor">Chen, L.</span>, <span class="refAuthor">Roginsky, A.</span>, <span class="refAuthor">Vassilev, A.</span>, and <span class="refAuthor">R. Davis</span>, <span class="refTitle">"Recommendation for pair-wise key-establishment schemes using discrete logarithm cryptography"</span>, <span class="seriesInfo">National Institute of Standards and Technology report</span>, <span class="seriesInfo">DOI 10.6028/nist.sp.800-56ar3</span>, <time datetime="2018-04" class="refDate">April 2018</time>, <span>&lt;<a href="https://doi.org/10.6028/nist.sp.800-56ar3">https://doi.org/10.6028/nist.sp.800-56ar3</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="LGR20">[LGR20]</dt>
        <dd>
<span class="refAuthor">Len, J.</span>, <span class="refAuthor">Grubbs, P.</span>, and <span class="refAuthor">T. Ristenpart</span>, <span class="refTitle">"Partitioning Oracle Attacks"</span>, <span>n.d.</span>, <span>&lt;<a href="https://eprint.iacr.org/2020/1491.pdf">https://eprint.iacr.org/2020/1491.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PAKE-Selection">[PAKE-Selection]</dt>
        <dd>
<span class="refTitle">"CFRG PAKE selection process repository"</span>, <span>n.d.</span>, <span>&lt;<a href="https://github.com/cfrg/pake-selection">https://github.com/cfrg/pake-selection</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PBKDF2">[PBKDF2]</dt>
        <dd>
<span class="refAuthor">Kaliski, B.</span>, <span class="refTitle">"PKCS #5: Password-Based Cryptography Specification Version 2.0"</span>, <span class="seriesInfo">RFC 2898</span>, <span class="seriesInfo">DOI 10.17487/RFC2898</span>, <time datetime="2000-09" class="refDate">September 2000</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2898">https://www.rfc-editor.org/rfc/rfc2898</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2945">[RFC2945]</dt>
        <dd>
<span class="refAuthor">Wu, T.</span>, <span class="refTitle">"The SRP Authentication and Key Exchange System"</span>, <span class="seriesInfo">RFC 2945</span>, <span class="seriesInfo">DOI 10.17487/RFC2945</span>, <time datetime="2000-09" class="refDate">September 2000</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2945">https://www.rfc-editor.org/rfc/rfc2945</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5869">[RFC5869]</dt>
        <dd>
<span class="refAuthor">Krawczyk, H.</span> and <span class="refAuthor">P. Eronen</span>, <span class="refTitle">"HMAC-based Extract-and-Expand Key Derivation Function (HKDF)"</span>, <span class="seriesInfo">RFC 5869</span>, <span class="seriesInfo">DOI 10.17487/RFC5869</span>, <time datetime="2010-05" class="refDate">May 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5869">https://www.rfc-editor.org/rfc/rfc5869</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8017">[RFC8017]</dt>
        <dd>
<span class="refAuthor">Moriarty, K., Ed.</span>, <span class="refAuthor">Kaliski, B.</span>, <span class="refAuthor">Jonsson, J.</span>, and <span class="refAuthor">A. Rusch</span>, <span class="refTitle">"PKCS #1: RSA Cryptography Specifications Version 2.2"</span>, <span class="seriesInfo">RFC 8017</span>, <span class="seriesInfo">DOI 10.17487/RFC8017</span>, <time datetime="2016-11" class="refDate">November 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8017">https://www.rfc-editor.org/rfc/rfc8017</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8125">[RFC8125]</dt>
        <dd>
<span class="refAuthor">Schmidt, J.</span>, <span class="refTitle">"Requirements for Password-Authenticated Key Agreement (PAKE) Schemes"</span>, <span class="seriesInfo">RFC 8125</span>, <span class="seriesInfo">DOI 10.17487/RFC8125</span>, <time datetime="2017-04" class="refDate">April 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8125">https://www.rfc-editor.org/rfc/rfc8125</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SCRYPT">[SCRYPT]</dt>
        <dd>
<span class="refAuthor">Percival, C.</span> and <span class="refAuthor">S. Josefsson</span>, <span class="refTitle">"The scrypt Password-Based Key Derivation Function"</span>, <span class="seriesInfo">RFC 7914</span>, <span class="seriesInfo">DOI 10.17487/RFC7914</span>, <time datetime="2016-08" class="refDate">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7914">https://www.rfc-editor.org/rfc/rfc7914</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SPAKE2plus">[SPAKE2plus]</dt>
        <dd>
<span class="refAuthor">Shoup, V.</span>, <span class="refTitle">"Security Analysis of SPAKE2+"</span>, <span class="seriesInfo">http://eprint.iacr.org/2020/313 </span>, <time datetime="2020" class="refDate">2020</time>. </dd>
<dd class="break"></dd>
<dt id="WhatsAppE2E">[WhatsAppE2E]</dt>
        <dd>
<span class="refTitle">"Security of End-to-End Encrypted Backups"</span>, <span>n.d.</span>, <span>&lt;<a href="https://www.whatsapp.com/security/WhatsApp_Security_Encrypted_Backups_Whitepaper.pdf">https://www.whatsapp.com/security/WhatsApp_Security_Encrypted_Backups_Whitepaper.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="_3DH">[_3DH]</dt>
      <dd>
<span class="refTitle">"Simplifying OTR deniability"</span>, <span class="seriesInfo">https://signal.org/blog/simplifying-otr-deniability </span>, <time datetime="2016" class="refDate">2016</time>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">The OPAQUE protocol and its analysis is joint work of the author with Stanislaw
Jarecki and Jiayu Xu. We are indebted to the OPAQUE reviewers during CFRG's
aPAKE selection process, particularly Julia Hesse and Bjorn Tackmann.
This draft has benefited from comments by multiple people. Special thanks
to Richard Barnes, Dan Brown, Eric Crockett, Paul Grubbs, Fredrik Kuivinen,
Payman Mohassel, Jason Resch, Greg Rubin, and Nick Sullivan.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alternate-key-recovery">
<section id="appendix-B">
      <h2 id="name-alternate-key-recovery-mech">
<a href="#appendix-B" class="section-number selfRef">Appendix B. </a><a href="#name-alternate-key-recovery-mech" class="section-name selfRef">Alternate Key Recovery Mechanisms</a>
      </h2>
<p id="appendix-B-1">Client authentication material can be stored and retrieved using different key
recovery mechanisms. Any key recovery mechanism that encrypts data
in the envelope MUST use an authenticated encryption scheme with random
key-robustness (or key-committing). Deviating from the key-robustness
requirement may open the protocol to attacks, e.g., <span>[<a href="#LGR20" class="xref">LGR20</a>]</span>.
This specification enforces this property by using a MAC over the envelope
contents.<a href="#appendix-B-1" class="pilcrow">¶</a></p>
<p id="appendix-B-2">We remark that export_key for authentication or encryption requires
no special properties from the authentication or encryption schemes
as long as export_key is used only after authentication material is successfully
recovered, i.e., after the MAC in RecoverCredentials passes verification.<a href="#appendix-B-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alternate-akes">
<section id="appendix-C">
      <h2 id="name-alternate-ake-instantiation">
<a href="#appendix-C" class="section-number selfRef">Appendix C. </a><a href="#name-alternate-ake-instantiation" class="section-name selfRef">Alternate AKE Instantiations</a>
      </h2>
<p id="appendix-C-1">It is possible to instantiate OPAQUE with other AKEs, such as HMQV <span>[<a href="#HMQV" class="xref">HMQV</a>]</span> and SIGMA-I.
HMQV is similar to 3DH but varies in its key schedule. SIGMA-I uses digital signatures
rather than static DH keys for authentication. Specification of these instantiations is
left to future documents. A sketch of how these instantiations might change is included
in the next subsection for posterity.<a href="#appendix-C-1" class="pilcrow">¶</a></p>
<p id="appendix-C-2">OPAQUE may also be instantiated with any post-quantum (PQ) AKE protocol that has the message
flow above and security properties (KCI resistance and forward secrecy) outlined
in <a href="#security-considerations" class="xref">Section 10</a>. Note that such an instantiation is not quantum-safe unless
the OPRF is quantum-safe. However, an OPAQUE instantiation where the AKE is quantum-safe,
but the OPRF is not, would still ensure the confidentiality of application data encrypted
under session_key (or a key derived from it) with a quantum-safe encryption function.<a href="#appendix-C-2" class="pilcrow">¶</a></p>
<div id="hmqv-sketch">
<section id="appendix-C.1">
        <h3 id="name-hmqv-instantiation-sketch">
<a href="#appendix-C.1" class="section-number selfRef">C.1. </a><a href="#name-hmqv-instantiation-sketch" class="section-name selfRef">HMQV Instantiation Sketch</a>
        </h3>
<p id="appendix-C.1-1">An HMQV instantiation would work similar to OPAQUE-3DH, differing primarily in the key
schedule <span>[<a href="#HMQV" class="xref">HMQV</a>]</span>. First, the key schedule <code>preamble</code> value would use a different constant prefix
-- "HMQV" instead of "3DH" -- as shown below.<a href="#appendix-C.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-C.1-2">
<pre>
preamble = concat("HMQV",
                  I2OSP(len(client_identity), 2), client_identity,
                  KE1,
                  I2OSP(len(server_identity), 2), server_identity,
                  KE2.credential_response,
                  KE2.auth_response.server_nonce,
                  KE2.auth_response.server_keyshare)
</pre><a href="#appendix-C.1-2" class="pilcrow">¶</a>
</div>
<p id="appendix-C.1-3">Second, the IKM derivation would change. Assuming HMQV is instantiated with a cyclic
group of prime order p with bit length L, clients would compute <code>IKM</code> as follows:<a href="#appendix-C.1-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-C.1-4">
<pre>
u' = (eskU + u \* skU) mod p
IKM = (epkS \* pkS^s)^u'
</pre><a href="#appendix-C.1-4" class="pilcrow">¶</a>
</div>
<p id="appendix-C.1-5">Likewise, servers would compute <code>IKM</code> as follows:<a href="#appendix-C.1-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-C.1-6">
<pre>
s' = (eskS + s \* skS) mod p
IKM = (epkU \* pkU^u)^s'
</pre><a href="#appendix-C.1-6" class="pilcrow">¶</a>
</div>
<p id="appendix-C.1-7">In both cases, <code>u</code> would be computed as follows:<a href="#appendix-C.1-7" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-C.1-8">
<pre>
hashInput = concat(I2OSP(len(epkU), 2), epkU,
                   I2OSP(len(info), 2), info,
                   I2OSP(len("client"), 2), "client")
u = Hash(hashInput) mod L
</pre><a href="#appendix-C.1-8" class="pilcrow">¶</a>
</div>
<p id="appendix-C.1-9">Likewise, <code>s</code> would be computed as follows:<a href="#appendix-C.1-9" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="appendix-C.1-10">
<pre>
hashInput = concat(I2OSP(len(epkS), 2), epkS,
                   I2OSP(len(info), 2), info,
                   I2OSP(len("server"), 2), "server")
s = Hash(hashInput) mod L
</pre><a href="#appendix-C.1-10" class="pilcrow">¶</a>
</div>
<p id="appendix-C.1-11">Hash is the same hash function used in the main OPAQUE protocol for key derivation.
Its output length (in bits) must be at least L.<a href="#appendix-C.1-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sigma-i-instantiation-sketch">
<section id="appendix-C.2">
        <h3 id="name-sigma-i-instantiation-sketc">
<a href="#appendix-C.2" class="section-number selfRef">C.2. </a><a href="#name-sigma-i-instantiation-sketc" class="section-name selfRef">SIGMA-I Instantiation Sketch</a>
        </h3>
<p id="appendix-C.2-1">A SIGMA-I instantiation differs more drastically from OPAQUE-3DH since authentication
uses digital signatures instead of Diffie Hellman. In particular, both KE2 and KE3
would carry a digital signature, computed using the server and client private keys
established during registration, respectively, as well as a MAC, where the MAC is
computed as in OPAQUE-3DH.<a href="#appendix-C.2-1" class="pilcrow">¶</a></p>
<p id="appendix-C.2-2">The key schedule would also change. Specifically, the key schedule <code>preamble</code> value would
use a different constant prefix -- "SIGMA-I" instead of "3DH" -- and the <code>IKM</code> computation
would use only the ephemeral key shares exchanged between client and server.<a href="#appendix-C.2-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="test-vectors">
<section id="appendix-D">
      <h2 id="name-test-vectors">
<a href="#appendix-D" class="section-number selfRef">Appendix D. </a><a href="#name-test-vectors" class="section-name selfRef">Test Vectors</a>
      </h2>
<p id="appendix-D-1">This section contains real and fake test vectors for the OPAQUE-3DH specification.
Each real test vector in <a href="#real-vectors" class="xref">Appendix D.1</a> specifies the configuration information,
protocol inputs, intermediate values computed during registration and authentication,
and protocol outputs.<a href="#appendix-D-1" class="pilcrow">¶</a></p>
<p id="appendix-D-2">Similarly, each fake test vector in <a href="#fake-vectors" class="xref">Appendix D.2</a> specifies
the configuration information, protocol inputs, and protocol
outputs computed during authentication of an unknown or unregistered user. Note that <code>masking_key</code>, <code>client_private_key</code>, and
<code>client_public_key</code> are used as additional inputs as described in
<a href="#create-credential-response" class="xref">Section 6.3.2.2</a>. <code>client_public_key</code> is used as the fake record's public key, and
<code>masking_key</code> for the fake record's masking key parameter.<a href="#appendix-D-2" class="pilcrow">¶</a></p>
<p id="appendix-D-3">All values are encoded in hexadecimal strings. The configuration information
includes the (OPRF, Hash, KSF, KDF, MAC, Group, Context) tuple, where the Group
matches that which is used in the OPRF. These test vectors were generated using
draft-10 of <span>[<a href="#OPRF" class="xref">OPRF</a>]</span>.<a href="#appendix-D-3" class="pilcrow">¶</a></p>
<div id="real-vectors">
<section id="appendix-D.1">
        <h3 id="name-real-test-vectors">
<a href="#appendix-D.1" class="section-number selfRef">D.1. </a><a href="#name-real-test-vectors" class="section-name selfRef">Real Test Vectors</a>
        </h3>
<div id="opaque-3dh-real-test-vector-1">
<section id="appendix-D.1.1">
          <h4 id="name-opaque-3dh-real-test-vector">
<a href="#appendix-D.1.1" class="section-number selfRef">D.1.1. </a><a href="#name-opaque-3dh-real-test-vector" class="section-name selfRef">OPAQUE-3DH Real Test Vector 1</a>
          </h4>
<div id="configuration">
<section id="appendix-D.1.1.1">
            <h5 id="name-configuration">
<a href="#appendix-D.1.1.1" class="section-number selfRef">D.1.1.1. </a><a href="#name-configuration" class="section-name selfRef">Configuration</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.1.1-1">
<pre>
OPRF: 0001
Hash: SHA512
KSF: Identity
KDF: HKDF-SHA512
MAC: HMAC-SHA512
Group: ristretto255
Context: 4f50415155452d504f43
Nh: 64
Npk: 32
Nsk: 32
Nm: 64
Nx: 64
Nok: 32
</pre><a href="#appendix-D.1.1.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="input-values">
<section id="appendix-D.1.1.2">
            <h5 id="name-input-values">
<a href="#appendix-D.1.1.2" class="section-number selfRef">D.1.1.2. </a><a href="#name-input-values" class="section-name selfRef">Input Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.1.2-1">
<pre>
oprf_seed: f433d0227b0b9dd54f7c4422b600e764e47fb503f1f9a0f0a47c6606b0
54a7fdc65347f1a08f277e22358bbabe26f823fca82c7848e9a75661f4ec5d5c1989e
f
credential_identifier: 31323334
password: 436f7272656374486f72736542617474657279537461706c65
envelope_nonce: ac13171b2f17bc2c74997f0fce1e1f35bec6b91fe2e12dbd323d2
3ba7a38dfec
masking_nonce: 38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80
f612fdfc6d
server_private_key: 47451a85372f8b3537e249d7b54188091fb18edde78094b43
e2ba42b5eb89f0d
server_public_key: b2fe7af9f48cc502d016729d2fe25cdd433f2c4bc904660b2a
382c9b79df1a78
server_nonce: 71cd9960ecef2fe0d0f7494986fa3d8b2bb01963537e60efb13981e
138e3d4a1
client_nonce: da7e07376d6d6f034cfa9bb537d11b8c6b4238c334333d1f0aebb38
0cae6a6cc
server_keyshare: c8c39f573135474c51660b02425bca633e339cec4e1acc69c94d
d48497fe4028
client_keyshare: 0c3a00c961fead8a16f818929cc976f0475e4f723519318b96f4
947a7a5f9663
server_private_keyshare: 2e842960258a95e28bcfef489cffd19d8ec99cc1375d
840f96936da7dbb0b40d
client_private_keyshare: 22c919134c9bdd9dc0c5ef3450f18b54820f43f646a9
5223bf4a85b2018c2001
blind_registration: 76cfbfe758db884bebb33582331ba9f159720ca8784a2a070
a265d9c2d6abe01
blind_login: 6ecc102d2e7a7cf49617aad7bbe188556792d4acd60a1a8a8d2b65d4
b0790308
</pre><a href="#appendix-D.1.1.2-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="intermediate-values">
<section id="appendix-D.1.1.3">
            <h5 id="name-intermediate-values">
<a href="#appendix-D.1.1.3" class="section-number selfRef">D.1.1.3. </a><a href="#name-intermediate-values" class="section-name selfRef">Intermediate Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.1.3-1">
<pre>
client_public_key: 8e5e5c04b2154336fa52ac691eb6df5f59ec7315b8467b0bba
1ed4f413043b44
auth_key: e1ff65c196e1c4b4bf46361798eec479b318831329680f33b4f77ad49d8
c6e6ef49d87082d654d21f2e36454582353fefc23c07637bd8ca4aa88a4461ea96d6c
randomized_pwd: 4386bf4b83db06f47672fd60b4cface554558da7be3c616c56b2e
d29b544d1b50bc45893b1c05d8d6866a9bbe91395e4704740be58728e8872352f56d5
319f8f
envelope: ac13171b2f17bc2c74997f0fce1e1f35bec6b91fe2e12dbd323d23ba7a3
8dfec8e8bde8d4eb9e171240b3d2dfb43ef93efe5cd15412614b3df11ecb58890047e
2fa31c283e7c58c40495226cfa0ed7756e493431b85c464aad7fdaaf1ab41ac7
handshake_secret: 885a0a7bd8e704d8fc26f62b8657f8c5d01ffb35b27ad538493
968dcf6dba7a2d42d404d6ed6a87805a030ffafe791fb69fd044c1ac152ee0ee78853
cebb0700
server_mac_key: d29e33eb506fbf199c818d1300e7253404a7d5de9c660a90f79af
e4cc15da2ae31e511c6eb1c4df95f47c9759606732781a3d1884a4d53cba690bdb9e9
ac4d7c
client_mac_key: 4d4d4c4b8b35501876ed01d07f5718357ff720163b84813b1bde4
f3b6ca3e1de744a267e3d145e6095a0e5b1617714e10af7e10093d0ba8dd115e6bdb1
f5ccd9
oprf_key: 6c246eaa55e47d0490ffa8a6f784e803eed9384a250458def36a2acebf1
5c905
</pre><a href="#appendix-D.1.1.3-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="output-values">
<section id="appendix-D.1.1.4">
            <h5 id="name-output-values">
<a href="#appendix-D.1.1.4" class="section-number selfRef">D.1.1.4. </a><a href="#name-output-values" class="section-name selfRef">Output Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.1.4-1">
<pre>
registration_request: 62235332ae15911d69812e9eeb6ac8fe4fa0ffc7590831d
5c5e1631e01049276
registration_response: 6268d13fea98ebc8e6b88d0b3cc8a78d2ac8fa8efc741c
d2e966940c52c31c71b2fe7af9f48cc502d016729d2fe25cdd433f2c4bc904660b2a3
82c9b79df1a78
registration_upload: 8e5e5c04b2154336fa52ac691eb6df5f59ec7315b8467b0b
ba1ed4f413043b449afea0ddedbbce5c083c5d5d02aa5218bcc7100f541d841bb5974
f084f7aa0b929399feb39efd17e13ce1035cbb23251da3b5126a574b239c7b73519d8
847e2fac13171b2f17bc2c74997f0fce1e1f35bec6b91fe2e12dbd323d23ba7a38dfe
c8e8bde8d4eb9e171240b3d2dfb43ef93efe5cd15412614b3df11ecb58890047e2fa3
1c283e7c58c40495226cfa0ed7756e493431b85c464aad7fdaaf1ab41ac7
KE1: 1670c409ebb699a6012629451d218d42a34eddba1d2978536c45e199c60a0b4e
da7e07376d6d6f034cfa9bb537d11b8c6b4238c334333d1f0aebb380cae6a6cc0c3a0
0c961fead8a16f818929cc976f0475e4f723519318b96f4947a7a5f9663
KE2: 36b4d06f413b72004392d7359cd6a998c667533203d6a671afe81ca09a282f72
38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80f612fdfc6d378cc
6b0113bf0b6afd9e0728e62ba793d5d25bb97794c154d036bf09c98c472368bffc4e3
5b7dc48f5a32dd3fede3b9e563f7a170d0e082d02c0a105cdf1ee0ea1928202076ff3
7ce174f2c669d52d8adc424e925a3bc9a4ca5ce16d9b7a1791ff7e47a0d2fa42424e5
476f8cfa7bb20b2796ad877295a996ffcb049313f4e971cd9960ecef2fe0d0f749498
6fa3d8b2bb01963537e60efb13981e138e3d4a1c8c39f573135474c51660b02425bca
633e339cec4e1acc69c94dd48497fe402848f3b062916ea7666973222944dabe1027e
5bea84b1b5d46dab64b1c6eda3170d4c9adba8afa61eb4153061d528b39102f32ecda
7d7625dbc229e6630a607e03
KE3: 4e23f0f84a5261918a7fc23bf1978a935cf4e320d56984079f8c7f4a54847b9e
979f519928c5898927cf6aa8d51ac42dc2d0f5840956caa3a34dbc55ce74415f
export_key: 403a270110164ae0de7ea77c6824343211e8c1663ccaedde908dc9acf
661039a379c8ac7e4b0cb23a8d1375ae94a772f91536de131d9d86633cb9445f773df
ac
session_key: d2dea308255aa3cecf72bcd6ac96ff7ab2e8bad0494b90180ad340b7
d8942a36ee358e76c372790d4a5c1ac900997ea2abbf35f2d65510f8dfd668e593b8e
1fe
</pre><a href="#appendix-D.1.1.4-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="opaque-3dh-real-test-vector-2">
<section id="appendix-D.1.2">
          <h4 id="name-opaque-3dh-real-test-vector-">
<a href="#appendix-D.1.2" class="section-number selfRef">D.1.2. </a><a href="#name-opaque-3dh-real-test-vector-" class="section-name selfRef">OPAQUE-3DH Real Test Vector 2</a>
          </h4>
<div id="configuration-1">
<section id="appendix-D.1.2.1">
            <h5 id="name-configuration-2">
<a href="#appendix-D.1.2.1" class="section-number selfRef">D.1.2.1. </a><a href="#name-configuration-2" class="section-name selfRef">Configuration</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.2.1-1">
<pre>
OPRF: 0001
Hash: SHA512
KSF: Identity
KDF: HKDF-SHA512
MAC: HMAC-SHA512
Group: ristretto255
Context: 4f50415155452d504f43
Nh: 64
Npk: 32
Nsk: 32
Nm: 64
Nx: 64
Nok: 32
</pre><a href="#appendix-D.1.2.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="input-values-1">
<section id="appendix-D.1.2.2">
            <h5 id="name-input-values-2">
<a href="#appendix-D.1.2.2" class="section-number selfRef">D.1.2.2. </a><a href="#name-input-values-2" class="section-name selfRef">Input Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.2.2-1">
<pre>
client_identity: 616c696365
server_identity: 626f62
oprf_seed: f433d0227b0b9dd54f7c4422b600e764e47fb503f1f9a0f0a47c6606b0
54a7fdc65347f1a08f277e22358bbabe26f823fca82c7848e9a75661f4ec5d5c1989e
f
credential_identifier: 31323334
password: 436f7272656374486f72736542617474657279537461706c65
envelope_nonce: ac13171b2f17bc2c74997f0fce1e1f35bec6b91fe2e12dbd323d2
3ba7a38dfec
masking_nonce: 38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80
f612fdfc6d
server_private_key: 47451a85372f8b3537e249d7b54188091fb18edde78094b43
e2ba42b5eb89f0d
server_public_key: b2fe7af9f48cc502d016729d2fe25cdd433f2c4bc904660b2a
382c9b79df1a78
server_nonce: 71cd9960ecef2fe0d0f7494986fa3d8b2bb01963537e60efb13981e
138e3d4a1
client_nonce: da7e07376d6d6f034cfa9bb537d11b8c6b4238c334333d1f0aebb38
0cae6a6cc
server_keyshare: c8c39f573135474c51660b02425bca633e339cec4e1acc69c94d
d48497fe4028
client_keyshare: 0c3a00c961fead8a16f818929cc976f0475e4f723519318b96f4
947a7a5f9663
server_private_keyshare: 2e842960258a95e28bcfef489cffd19d8ec99cc1375d
840f96936da7dbb0b40d
client_private_keyshare: 22c919134c9bdd9dc0c5ef3450f18b54820f43f646a9
5223bf4a85b2018c2001
blind_registration: 76cfbfe758db884bebb33582331ba9f159720ca8784a2a070
a265d9c2d6abe01
blind_login: 6ecc102d2e7a7cf49617aad7bbe188556792d4acd60a1a8a8d2b65d4
b0790308
</pre><a href="#appendix-D.1.2.2-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="intermediate-values-1">
<section id="appendix-D.1.2.3">
            <h5 id="name-intermediate-values-2">
<a href="#appendix-D.1.2.3" class="section-number selfRef">D.1.2.3. </a><a href="#name-intermediate-values-2" class="section-name selfRef">Intermediate Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.2.3-1">
<pre>
client_public_key: 8e5e5c04b2154336fa52ac691eb6df5f59ec7315b8467b0bba
1ed4f413043b44
auth_key: e1ff65c196e1c4b4bf46361798eec479b318831329680f33b4f77ad49d8
c6e6ef49d87082d654d21f2e36454582353fefc23c07637bd8ca4aa88a4461ea96d6c
randomized_pwd: 4386bf4b83db06f47672fd60b4cface554558da7be3c616c56b2e
d29b544d1b50bc45893b1c05d8d6866a9bbe91395e4704740be58728e8872352f56d5
319f8f
envelope: ac13171b2f17bc2c74997f0fce1e1f35bec6b91fe2e12dbd323d23ba7a3
8dfec43084457c1ffa561c8f37fbad1b8de6c41e6df200e6ebe15d5ce4243fa973ef3
e480644e56a6de865cc4d3d9e20e0510e63474e2b11f4b4c8f665cc439cc2d7d
handshake_secret: 19d0d9f286f44f573dd61435690b0359c3a70e5c363ba4819ac
fa113b0ddeab603f322185812ddcdd2abbfba77933cd5c3430ea6591e99c30a19884a
80d25dab
server_mac_key: 5096c1f1b295521bc8c5aeba462fc11e123eb710899f164dab737
45f55f42b27a31f810efb06fc56890f3635a18f3f8c9ef7881f32a251a5f5a7354c82
70f257
client_mac_key: 1c284c2a22bfb415a5091c94726dd02ae9adb12d28db5207a87be
0c3f75c1c37df549315f51e0dd2053271a477a45bf0adbc246f7f7e47e201785b6429
e93a84
oprf_key: 6c246eaa55e47d0490ffa8a6f784e803eed9384a250458def36a2acebf1
5c905
</pre><a href="#appendix-D.1.2.3-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="output-values-1">
<section id="appendix-D.1.2.4">
            <h5 id="name-output-values-2">
<a href="#appendix-D.1.2.4" class="section-number selfRef">D.1.2.4. </a><a href="#name-output-values-2" class="section-name selfRef">Output Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.2.4-1">
<pre>
registration_request: 62235332ae15911d69812e9eeb6ac8fe4fa0ffc7590831d
5c5e1631e01049276
registration_response: 6268d13fea98ebc8e6b88d0b3cc8a78d2ac8fa8efc741c
d2e966940c52c31c71b2fe7af9f48cc502d016729d2fe25cdd433f2c4bc904660b2a3
82c9b79df1a78
registration_upload: 8e5e5c04b2154336fa52ac691eb6df5f59ec7315b8467b0b
ba1ed4f413043b449afea0ddedbbce5c083c5d5d02aa5218bcc7100f541d841bb5974
f084f7aa0b929399feb39efd17e13ce1035cbb23251da3b5126a574b239c7b73519d8
847e2fac13171b2f17bc2c74997f0fce1e1f35bec6b91fe2e12dbd323d23ba7a38dfe
c43084457c1ffa561c8f37fbad1b8de6c41e6df200e6ebe15d5ce4243fa973ef3e480
644e56a6de865cc4d3d9e20e0510e63474e2b11f4b4c8f665cc439cc2d7d
KE1: 1670c409ebb699a6012629451d218d42a34eddba1d2978536c45e199c60a0b4e
da7e07376d6d6f034cfa9bb537d11b8c6b4238c334333d1f0aebb380cae6a6cc0c3a0
0c961fead8a16f818929cc976f0475e4f723519318b96f4947a7a5f9663
KE2: 36b4d06f413b72004392d7359cd6a998c667533203d6a671afe81ca09a282f72
38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80f612fdfc6d378cc
6b0113bf0b6afd9e0728e62ba793d5d25bb97794c154d036bf09c98c472368bffc4e3
5b7dc48f5a32dd3fede3b9e563f7a170d0e082d02c0a105cdf1ee0279ab2faaf30bb2
722ef0dbb4c66632703c736dc6aeb163c467a60e0abb09bf4d4d49c1c65f522667cb4
b6da94faa9d7835ad67e8e3198afb4e64d6fb06bc35371cd9960ecef2fe0d0f749498
6fa3d8b2bb01963537e60efb13981e138e3d4a1c8c39f573135474c51660b02425bca
633e339cec4e1acc69c94dd48497fe4028dfe19d6cf6d292ae99a497f9ba41702a194
5f5d9f3ab60ea801b5a691098c7af74956a5e1324322877b6d399583670e54dc90752
5235fd47c8e396fab340beed
KE3: 824fe89731cd47062819165662cd1c42c4b2d2321bd062e637fdd0361b0dad03
02bd5e9a9d02c72452dc65298bf330071e061b8bb4e1c8762a350d99c8c003ac
export_key: 403a270110164ae0de7ea77c6824343211e8c1663ccaedde908dc9acf
661039a379c8ac7e4b0cb23a8d1375ae94a772f91536de131d9d86633cb9445f773df
ac
session_key: 5ea9a76f5f5cc59ba7871012836947c946f8c303cc94e048cdc83ada
c89db7187cf5c718ffdd7cb6d8c3005dc0f77814d5f26011b584f9622c649a357cb17
a4c
</pre><a href="#appendix-D.1.2.4-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="opaque-3dh-real-test-vector-3">
<section id="appendix-D.1.3">
          <h4 id="name-opaque-3dh-real-test-vector-3">
<a href="#appendix-D.1.3" class="section-number selfRef">D.1.3. </a><a href="#name-opaque-3dh-real-test-vector-3" class="section-name selfRef">OPAQUE-3DH Real Test Vector 3</a>
          </h4>
<div id="configuration-2">
<section id="appendix-D.1.3.1">
            <h5 id="name-configuration-3">
<a href="#appendix-D.1.3.1" class="section-number selfRef">D.1.3.1. </a><a href="#name-configuration-3" class="section-name selfRef">Configuration</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.3.1-1">
<pre>
OPRF: 0003
Hash: SHA256
KSF: Identity
KDF: HKDF-SHA256
MAC: HMAC-SHA256
Group: P256_XMD:SHA-256_SSWU_RO_
Context: 4f50415155452d504f43
Nh: 32
Npk: 33
Nsk: 32
Nm: 32
Nx: 32
Nok: 32
</pre><a href="#appendix-D.1.3.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="input-values-2">
<section id="appendix-D.1.3.2">
            <h5 id="name-input-values-3">
<a href="#appendix-D.1.3.2" class="section-number selfRef">D.1.3.2. </a><a href="#name-input-values-3" class="section-name selfRef">Input Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.3.2-1">
<pre>
oprf_seed: 62f60b286d20ce4fd1d64809b0021dad6ed5d52a2c8cf27ae6582543a0
a8dce2
credential_identifier: 31323334
password: 436f7272656374486f72736542617474657279537461706c65
envelope_nonce: a921f2a014513bd8a90e477a629794e89fec12d12206dde662ebd
cf65670e51f
masking_nonce: 38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80
f612fdfc6d
server_private_key: c36139381df63bfc91c850db0b9cfbec7a62e86d80040a41a
a7725bf0e79d5e5
server_public_key: 035f40ff9cf88aa1f5cd4fe5fd3da9ea65a4923a5594f84fd9
f2092d6067784874
server_nonce: 71cd9960ecef2fe0d0f7494986fa3d8b2bb01963537e60efb13981e
138e3d4a1
client_nonce: ab3d33bde0e93eda72392346a7a73051110674bbf6b1b7ffab8be4f
91fdaeeb1
server_keyshare: 020e67941e94deba835214421d2d8c90de9b0f7f925d11e2032c
e19b1832ae8e0f
client_keyshare: 03493f36ca12467d1f5eaaabea67ca31377c4869c1e9a62346b6
f01a991624b95d
server_private_keyshare: 9addab838c920fa7044f3a46b91ecaea24b0e7203992
8ee7d4c37a5b9bc17349
client_private_keyshare: 89d5a7e18567f255748a86beac13913df755a5adf776
d69e143147b545d22134
blind_registration: 411bf1a62d119afe30df682b91a0a33d777972d4f2daa4b34
ca527d597078153
blind_login: c497fddf6056d241e6cf9fb7ac37c384f49b357a221eb0a802c989b9
942256c1
</pre><a href="#appendix-D.1.3.2-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="intermediate-values-2">
<section id="appendix-D.1.3.3">
            <h5 id="name-intermediate-values-3">
<a href="#appendix-D.1.3.3" class="section-number selfRef">D.1.3.3. </a><a href="#name-intermediate-values-3" class="section-name selfRef">Intermediate Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.3.3-1">
<pre>
client_public_key: 03763748cc2dfe4f6f80f8e4f3087b2d2222a7c9ba7d3c3aa8
e89c4975eed0999f
auth_key: 1fa6020180e18dde869f4f8363fc1b6841dbbc9fc9d258ece830af7efc2
5abdb
randomized_pwd: 4138e29dc8398d8c83b89129cb29ee5dc962fcb5fb2dca25981cb
351b83e0546
envelope: a921f2a014513bd8a90e477a629794e89fec12d12206dde662ebdcf6567
0e51fc82109537121d7c39d96f3e04732e1f0b8cc55d98bb4e5968ace317de1d42c3d
handshake_secret: 21c9ee3561e6924110d86f99a624fe2fdc1aeea03f1b17c279f
b94da851e3686
server_mac_key: 87cab7092d3219b613459ea1ec2973be054367b331937d6973181
2f418425082
client_mac_key: 9dffe56b53981e86b37553beedb5d2226465a02d75d577bacef82
9775494bd93
oprf_key: 59984c44639e303cd46912ce722fc7d042023f25e264a3775667ea63c30
add69
</pre><a href="#appendix-D.1.3.3-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="output-values-2">
<section id="appendix-D.1.3.4">
            <h5 id="name-output-values-3">
<a href="#appendix-D.1.3.4" class="section-number selfRef">D.1.3.4. </a><a href="#name-output-values-3" class="section-name selfRef">Output Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.3.4-1">
<pre>
registration_request: 0271e8fd723a873d16ddbda1d3700b9a42eca179ba09a8f
c2a2e40a8142fa35fe0
registration_response: 03c6fe2c086fa5333a15c5718ddda1f15a61e9ea9a0c4a
36f5f0dfe4f090250a70035f40ff9cf88aa1f5cd4fe5fd3da9ea65a4923a5594f84fd
9f2092d6067784874
registration_upload: 03763748cc2dfe4f6f80f8e4f3087b2d2222a7c9ba7d3c3a
a8e89c4975eed0999f5b042a53415b5db1161dacf9f9ef0c30ed6b0179038e5e8e5a0
aa087c8bc0753a921f2a014513bd8a90e477a629794e89fec12d12206dde662ebdcf6
5670e51fc82109537121d7c39d96f3e04732e1f0b8cc55d98bb4e5968ace317de1d42
c3d
KE1: 036514cf26a2578f1a45ea8faf540e52b237236ee97dc54948eca7b7f71ba9e1
29ab3d33bde0e93eda72392346a7a73051110674bbf6b1b7ffab8be4f91fdaeeb1034
93f36ca12467d1f5eaaabea67ca31377c4869c1e9a62346b6f01a991624b95d
KE2: 036ebcb79716cf2ecd0b3e5f3141709f72feb7369d2de41c61e0fa5695e78385
3e38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80f612fdfc6d286
5751562662eea8de000fdfd4cd1bf506b137d12f28bffaf11a0d720c6ddfe532b2aff
31acb0a8fbb89de1e29cc5a93a33f2e259cf59ad6c88a473d5f056aeb2b6b5eb03a0e
21e32a309373ed45506c3f58bf3d9978925cbf35b337e8ae220be71cd9960ecef2fe0
d0f7494986fa3d8b2bb01963537e60efb13981e138e3d4a1020e67941e94deba83521
4421d2d8c90de9b0f7f925d11e2032ce19b1832ae8e0fb6eda25f9a67e3930e862860
02b8dd8b6339ddfdbaebaefe205fe474fb66884d
KE3: 4fd2178c39492f816796db05aa2400204944d6bc5ed4a1e4d7b8b24b9f1894bc
export_key: 00e1f2a1613c78183ec5127f805d320f31ce5dfef70d78f64d327d6c6
e325ae1
session_key: e39ed0c2a0b551bad5e9e8bb7017c66918d514b6412a4e30d4cac7a7
08d35646
</pre><a href="#appendix-D.1.3.4-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="opaque-3dh-real-test-vector-4">
<section id="appendix-D.1.4">
          <h4 id="name-opaque-3dh-real-test-vector-4">
<a href="#appendix-D.1.4" class="section-number selfRef">D.1.4. </a><a href="#name-opaque-3dh-real-test-vector-4" class="section-name selfRef">OPAQUE-3DH Real Test Vector 4</a>
          </h4>
<div id="configuration-3">
<section id="appendix-D.1.4.1">
            <h5 id="name-configuration-4">
<a href="#appendix-D.1.4.1" class="section-number selfRef">D.1.4.1. </a><a href="#name-configuration-4" class="section-name selfRef">Configuration</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.4.1-1">
<pre>
OPRF: 0003
Hash: SHA256
KSF: Identity
KDF: HKDF-SHA256
MAC: HMAC-SHA256
Group: P256_XMD:SHA-256_SSWU_RO_
Context: 4f50415155452d504f43
Nh: 32
Npk: 33
Nsk: 32
Nm: 32
Nx: 32
Nok: 32
</pre><a href="#appendix-D.1.4.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="input-values-3">
<section id="appendix-D.1.4.2">
            <h5 id="name-input-values-4">
<a href="#appendix-D.1.4.2" class="section-number selfRef">D.1.4.2. </a><a href="#name-input-values-4" class="section-name selfRef">Input Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.4.2-1">
<pre>
client_identity: 616c696365
server_identity: 626f62
oprf_seed: 62f60b286d20ce4fd1d64809b0021dad6ed5d52a2c8cf27ae6582543a0
a8dce2
credential_identifier: 31323334
password: 436f7272656374486f72736542617474657279537461706c65
envelope_nonce: a921f2a014513bd8a90e477a629794e89fec12d12206dde662ebd
cf65670e51f
masking_nonce: 38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80
f612fdfc6d
server_private_key: c36139381df63bfc91c850db0b9cfbec7a62e86d80040a41a
a7725bf0e79d5e5
server_public_key: 035f40ff9cf88aa1f5cd4fe5fd3da9ea65a4923a5594f84fd9
f2092d6067784874
server_nonce: 71cd9960ecef2fe0d0f7494986fa3d8b2bb01963537e60efb13981e
138e3d4a1
client_nonce: ab3d33bde0e93eda72392346a7a73051110674bbf6b1b7ffab8be4f
91fdaeeb1
server_keyshare: 020e67941e94deba835214421d2d8c90de9b0f7f925d11e2032c
e19b1832ae8e0f
client_keyshare: 03493f36ca12467d1f5eaaabea67ca31377c4869c1e9a62346b6
f01a991624b95d
server_private_keyshare: 9addab838c920fa7044f3a46b91ecaea24b0e7203992
8ee7d4c37a5b9bc17349
client_private_keyshare: 89d5a7e18567f255748a86beac13913df755a5adf776
d69e143147b545d22134
blind_registration: 411bf1a62d119afe30df682b91a0a33d777972d4f2daa4b34
ca527d597078153
blind_login: c497fddf6056d241e6cf9fb7ac37c384f49b357a221eb0a802c989b9
942256c1
</pre><a href="#appendix-D.1.4.2-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="intermediate-values-3">
<section id="appendix-D.1.4.3">
            <h5 id="name-intermediate-values-4">
<a href="#appendix-D.1.4.3" class="section-number selfRef">D.1.4.3. </a><a href="#name-intermediate-values-4" class="section-name selfRef">Intermediate Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.4.3-1">
<pre>
client_public_key: 03763748cc2dfe4f6f80f8e4f3087b2d2222a7c9ba7d3c3aa8
e89c4975eed0999f
auth_key: 1fa6020180e18dde869f4f8363fc1b6841dbbc9fc9d258ece830af7efc2
5abdb
randomized_pwd: 4138e29dc8398d8c83b89129cb29ee5dc962fcb5fb2dca25981cb
351b83e0546
envelope: a921f2a014513bd8a90e477a629794e89fec12d12206dde662ebdcf6567
0e51f6f7b04d6f92795c9bdb72da5ebe7745b8a6c38fc64c391b1be60b4f49ff2ce67
handshake_secret: 2bbe0da5102418c041884e9d42e62c946255138d74ea3d69acd
013bf2240c849
server_mac_key: 2b23b08101bbecc22352f1580cd73c1678affdca160ec8cfccbe0
e808029d192
client_mac_key: e279a0b44ae7c1ffb57e7cf179369c6282a18e38e6d1d070eee81
a44062d59e5
oprf_key: 59984c44639e303cd46912ce722fc7d042023f25e264a3775667ea63c30
add69
</pre><a href="#appendix-D.1.4.3-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="output-values-3">
<section id="appendix-D.1.4.4">
            <h5 id="name-output-values-4">
<a href="#appendix-D.1.4.4" class="section-number selfRef">D.1.4.4. </a><a href="#name-output-values-4" class="section-name selfRef">Output Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.1.4.4-1">
<pre>
registration_request: 0271e8fd723a873d16ddbda1d3700b9a42eca179ba09a8f
c2a2e40a8142fa35fe0
registration_response: 03c6fe2c086fa5333a15c5718ddda1f15a61e9ea9a0c4a
36f5f0dfe4f090250a70035f40ff9cf88aa1f5cd4fe5fd3da9ea65a4923a5594f84fd
9f2092d6067784874
registration_upload: 03763748cc2dfe4f6f80f8e4f3087b2d2222a7c9ba7d3c3a
a8e89c4975eed0999f5b042a53415b5db1161dacf9f9ef0c30ed6b0179038e5e8e5a0
aa087c8bc0753a921f2a014513bd8a90e477a629794e89fec12d12206dde662ebdcf6
5670e51f6f7b04d6f92795c9bdb72da5ebe7745b8a6c38fc64c391b1be60b4f49ff2c
e67
KE1: 036514cf26a2578f1a45ea8faf540e52b237236ee97dc54948eca7b7f71ba9e1
29ab3d33bde0e93eda72392346a7a73051110674bbf6b1b7ffab8be4f91fdaeeb1034
93f36ca12467d1f5eaaabea67ca31377c4869c1e9a62346b6f01a991624b95d
KE2: 036ebcb79716cf2ecd0b3e5f3141709f72feb7369d2de41c61e0fa5695e78385
3e38fe59af0df2c79f57b8780278f5ae47355fe1f817119041951c80f612fdfc6d286
5751562662eea8de000fdfd4cd1bf506b137d12f28bffaf11a0d720c6ddfe532b2aff
31acb0a8fbb89de1e29cc5a93a33f2e259cf59ad6c88a473d5f056aeb211efe68628e
45c388328e97b78809368c72b9efc78fe51ecc7f5b6f7f4c4c2e471cd9960ecef2fe0
d0f7494986fa3d8b2bb01963537e60efb13981e138e3d4a1020e67941e94deba83521
4421d2d8c90de9b0f7f925d11e2032ce19b1832ae8e0f182fa038ada128f4440131f9
8adc14cfbdf9045d95b6a55db9b38ffd0aa539f7
KE3: a9a61a2442845e83b86c22d56ff038893208fcb0e2026d65e2a04f87497e873f
export_key: 00e1f2a1613c78183ec5127f805d320f31ce5dfef70d78f64d327d6c6
e325ae1
session_key: 9d15a7020c089b7c7ab7d6341e34a16260279b59dda8d63cabd3da0b
a14da32c
</pre><a href="#appendix-D.1.4.4-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="fake-vectors">
<section id="appendix-D.2">
        <h3 id="name-fake-test-vectors">
<a href="#appendix-D.2" class="section-number selfRef">D.2. </a><a href="#name-fake-test-vectors" class="section-name selfRef">Fake Test Vectors</a>
        </h3>
<div id="opaque-3dh-fake-test-vector-1">
<section id="appendix-D.2.1">
          <h4 id="name-opaque-3dh-fake-test-vector">
<a href="#appendix-D.2.1" class="section-number selfRef">D.2.1. </a><a href="#name-opaque-3dh-fake-test-vector" class="section-name selfRef">OPAQUE-3DH Fake Test Vector 1</a>
          </h4>
<div id="configuration-4">
<section id="appendix-D.2.1.1">
            <h5 id="name-configuration-5">
<a href="#appendix-D.2.1.1" class="section-number selfRef">D.2.1.1. </a><a href="#name-configuration-5" class="section-name selfRef">Configuration</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.2.1.1-1">
<pre>
OPRF: 0001
Hash: SHA512
KSF: Identity
KDF: HKDF-SHA512
MAC: HMAC-SHA512
Group: ristretto255
Context: 4f50415155452d504f43
Nh: 64
Npk: 32
Nsk: 32
Nm: 64
Nx: 64
Nok: 32
</pre><a href="#appendix-D.2.1.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="input-values-4">
<section id="appendix-D.2.1.2">
            <h5 id="name-input-values-5">
<a href="#appendix-D.2.1.2" class="section-number selfRef">D.2.1.2. </a><a href="#name-input-values-5" class="section-name selfRef">Input Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.2.1.2-1">
<pre>
client_identity: 616c696365
server_identity: 626f62
oprf_seed: 743fc168d1f826ad43738933e5adb23da6fb95f95a1b069f0daa0522d0
a78b617f701fc6aa46d3e7981e70de7765dfcd6b1e13e3369a582eb8dc456b10aa53b
0
credential_identifier: 31323334
masking_nonce: 9c035896a043e70f897d87180c543e7a063b83c1bb728fbd189c61
9e27b6e5a6
client_private_key: 2b98980aa95ab53a0f39f0291903d2fdf04b00c167f081416
9922df873002409
client_public_key: 84f43f9492e19c22d8bdaa4447cc3d4db1cdb5427a9f852c47
07921212c36251
server_private_key: c788585ae8b5ba2942b693b849be0c0426384e41977c18d2e
81fbe30fd7c9f06
server_public_key: 825f832667480f08b0c9069da5083ac4d0e9ee31b49c4e0310
031fea04d52966
server_nonce: 1e10f6eeab2a7a420bf09da9b27a4639645622c46358de9cf7ae813
055ae2d12
server_keyshare: 5236e2e06d49f0b496db2a786f6ee1016f15b4fd6c0dbd95d6b1
17055d914157
server_private_keyshare: 6d8fba9741a357584770f85294430bce2252fe212a8a
372152a73c7ffe414503
masking_key: 39ebd51f0e39a07a1c2d2431995b0399bca9996c5d10014d6ebab445
3dc10ce5cef38ed3df6e56bfff40c2d8dd4671c2b4cf63c3d54860f31fe40220d690b
b71
KE1: 20098d3321812eab08e9f3ccd5640d26194cb5cf73f4c5d551f9fea8f5a5765f
42d4e61ed3f8d64cdd3b9d153343eca15b9b0d5e388232793c6376bd2d9cfd0a0e4ed
8bcc15f3dd01a30365c97c0c0de0a3dd3fbf5d3cbec55fb6ac1d3bf740f
</pre><a href="#appendix-D.2.1.2-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="output-values-4">
<section id="appendix-D.2.1.3">
            <h5 id="name-output-values-5">
<a href="#appendix-D.2.1.3" class="section-number selfRef">D.2.1.3. </a><a href="#name-output-values-5" class="section-name selfRef">Output Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.2.1.3-1">
<pre>
KE2: e891a2527f657f5a72d723c735e9c3ae9179275f8e74f89a81418561b1db5670
9c035896a043e70f897d87180c543e7a063b83c1bb728fbd189c619e27b6e5a632b5a
b1bff96636144faa4f9f9afaac75dd88ea99cf5175902ae3f3b2195693f165f11929b
a510a5978e64dcdabecbd7ee1e4380ce270e58fea58e6462d92964a1aaef72698bca1
c673baeb04cc2bf7de5f3c2f5553464552d3a0f7698a9ca7f9c5e70c6cb1f706b2f17
5ab9d04bbd13926e816b6811a50b4aafa9799d5ed7971e10f6eeab2a7a420bf09da9b
27a4639645622c46358de9cf7ae813055ae2d125236e2e06d49f0b496db2a786f6ee1
016f15b4fd6c0dbd95d6b117055d9141571ef6a1ac9c84f21e6914ecb5d2020fe50c2
5b3c026b9f7a877c7526c13309cc4dd4d33050932c627813a67ceb1d3a8e0065fd55a
054296ef3097c6a8a04ac33c
</pre><a href="#appendix-D.2.1.3-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="opaque-3dh-fake-test-vector-2">
<section id="appendix-D.2.2">
          <h4 id="name-opaque-3dh-fake-test-vector-">
<a href="#appendix-D.2.2" class="section-number selfRef">D.2.2. </a><a href="#name-opaque-3dh-fake-test-vector-" class="section-name selfRef">OPAQUE-3DH Fake Test Vector 2</a>
          </h4>
<div id="configuration-5">
<section id="appendix-D.2.2.1">
            <h5 id="name-configuration-6">
<a href="#appendix-D.2.2.1" class="section-number selfRef">D.2.2.1. </a><a href="#name-configuration-6" class="section-name selfRef">Configuration</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.2.2.1-1">
<pre>
OPRF: 0003
Hash: SHA256
KSF: Identity
KDF: HKDF-SHA256
MAC: HMAC-SHA256
Group: P256_XMD:SHA-256_SSWU_RO_
Context: 4f50415155452d504f43
Nh: 32
Npk: 33
Nsk: 32
Nm: 32
Nx: 32
Nok: 32
</pre><a href="#appendix-D.2.2.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="input-values-5">
<section id="appendix-D.2.2.2">
            <h5 id="name-input-values-6">
<a href="#appendix-D.2.2.2" class="section-number selfRef">D.2.2.2. </a><a href="#name-input-values-6" class="section-name selfRef">Input Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.2.2.2-1">
<pre>
client_identity: 616c696365
server_identity: 626f62
oprf_seed: bb1cd59e16ac09bc0cb6d528541695d7eba2239b1613a3db3ade77b362
80f725
credential_identifier: 31323334
masking_nonce: 9c035896a043e70f897d87180c543e7a063b83c1bb728fbd189c61
9e27b6e5a6
client_private_key: d423b87899fc61d014fc8330a4e26190fcfa470a3afe59243
24294af7dbbc1dd
client_public_key: 03b81708eae026a9370616c22e1e8542fe9dbebd36ce8a2661
b708e9628f4a57fc
server_private_key: 34fbe7e830be1fe8d2187c97414e3826040cbe49b893b6422
9bab5e85a5888c7
server_public_key: 0221e034c0e202fe883dcfc96802a7624166fed4cfcab4ae30
cf5f3290d01c88bf
server_nonce: 1e10f6eeab2a7a420bf09da9b27a4639645622c46358de9cf7ae813
055ae2d12
server_keyshare: 03f42965d5bcba2a590a49eb2418061effe40b5c29a34b8e5163
e0ef32044b2e4c
server_private_keyshare: 1a2a0ff27f3ca75221378a2a21fe5222ce0b439452f8
70475857a34197ba8f6d
masking_key: caecc6ccb4cae27cb54d8f3a1af1bac52a3d53107ce08497cdd362b1
992e4e5e
KE1: 0223afb7e2362271bdf2e20c62e25819e65d379308dfa4d9911f2fc7ada2296f
7f42d4e61ed3f8d64cdd3b9d153343eca15b9b0d5e388232793c6376bd2d9cfd0a039
94d4f1221bfd205063469e92ea4d492f7cc76a327223633ab74590c30cf7285
</pre><a href="#appendix-D.2.2.2-1" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="output-values-5">
<section id="appendix-D.2.2.3">
            <h5 id="name-output-values-6">
<a href="#appendix-D.2.2.3" class="section-number selfRef">D.2.2.3. </a><a href="#name-output-values-6" class="section-name selfRef">Output Values</a>
            </h5>
<div class="alignLeft art-text artwork" id="appendix-D.2.2.3-1">
<pre>
KE2: 029c5324a734851923b27ea573dce1c2ed10c497ee222c5500763c96c5209db0
cd9c035896a043e70f897d87180c543e7a063b83c1bb728fbd189c619e27b6e5a6fac
da65ce0a97b9085e7af07f61fd3fdd046d257cbf2183ce8766090b8041a8bf28d79dd
4c9031ddc75bb6ddb4c291e639937840e3d39fc0d5a3d6e7723c09f7945df485bcf9a
efe3fe82d149e84049e259bb5b33d6a2ff3b25e4bfb7eff0962821e10f6eeab2a7a42
0bf09da9b27a4639645622c46358de9cf7ae813055ae2d1203f42965d5bcba2a590a4
9eb2418061effe40b5c29a34b8e5163e0ef32044b2e4c1bf93ad07640bc9ed22e2a33
8734d55d0d22f5cc16d179e5aa4cce845b9a04a8
</pre><a href="#appendix-D.2.2.3-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-E">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Daniel Bourdrez</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:d@bytema.re" class="email">d@bytema.re</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Hugo Krawczyk</span></div>
<div dir="auto" class="left"><span class="org">Algorand Foundation</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:hugokraw@gmail.com" class="email">hugokraw@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Kevin Lewi</span></div>
<div dir="auto" class="left"><span class="org">Novi Research</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:lewi.kevin.k@gmail.com" class="email">lewi.kevin.k@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare, Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:caw@heapingbits.net" class="email">caw@heapingbits.net</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
